<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lark快捷採購 v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* Apple 系统颜色 */
            --apple-blue: rgb(0, 122, 255);
            --apple-green: rgb(52, 199, 89);
            --apple-indigo: rgb(88, 86, 214);
            --apple-orange: rgb(255, 149, 0);
            --apple-pink: rgb(255, 45, 85);
            --apple-purple: rgb(175, 82, 222);
            --apple-red: rgb(255, 59, 48);
            --apple-teal: rgb(90, 200, 250);
            --apple-yellow: rgb(255, 204, 0);
            --apple-gray1: rgb(142, 142, 147);
            --apple-gray2: rgb(174, 174, 178);
            --apple-gray3: rgb(199, 199, 204);
            --apple-gray4: rgb(209, 209, 214);
            --apple-gray5: rgb(229, 229, 234);
            --apple-gray6: rgb(242, 242, 247);
            
            /* 深色模式颜色 */
            --apple-dark-blue: rgb(10, 132, 255);
            --apple-dark-green: rgb(48, 209, 88);
            --apple-dark-indigo: rgb(94, 92, 230);
            --apple-dark-orange: rgb(255, 159, 10);
            --apple-dark-pink: rgb(255, 55, 95);
            --apple-dark-purple: rgb(191, 90, 242);
            --apple-dark-red: rgb(255, 69, 58);
            --apple-dark-teal: rgb(100, 210, 255);
            --apple-dark-yellow: rgb(255, 214, 10);
            --apple-dark-gray1: rgb(142, 142, 147);
            --apple-dark-gray2: rgb(99, 99, 102);
            --apple-dark-gray3: rgb(72, 72, 74);
            --apple-dark-gray4: rgb(58, 58, 60);
            --apple-dark-gray5: rgb(44, 44, 46);
            --apple-dark-gray6: rgb(28, 28, 30);
        }

        /* 全局动画过渡 */
        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--apple-gray5);
            padding: 20px;
            margin: 12px 0;
            cursor: pointer;
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card:active {
            transform: scale(0.98);
        }

        .input-number {
            width: 80px;
            text-align: center;
            border: 1px solid var(--apple-gray4);
            border-radius: 12px;
            padding: 8px;
            font-size: 16px;
            background: white;
            color: var(--apple-dark-gray2);
        }

        .input-number:focus {
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            outline: none;
            background: white;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            background: var(--apple-blue);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .status-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-left: 12px;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            font-weight: 500;
        }

        .status-connecting {
            background: var(--apple-yellow);
            color: #000;
        }

        .status-success {
            background: var(--apple-green);
            color: white;
        }

        .status-error {
            background: var(--apple-red);
            color: white;
        }

        .search-box {
            width: 100%;
            max-width: 500px;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            margin-bottom: 20px;
            background: var(--apple-gray6);
            color: var(--apple-dark-gray2);
        }

        .search-box:focus {
            background: white;
            border: 1px solid var(--apple-gray4);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05),
                        0 4px 16px rgba(0, 0, 0, 0.03);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-container {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 1px 0 var(--apple-gray5);
        }

        .notification {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--apple-dark-gray2);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            z-index: 9999;
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background: var(--apple-green);
        }

        .notification.error {
            background: var(--apple-red);
        }

        .history-panel {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--apple-gray5);
        }

        /* 动画关键帧 */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* 触觉反馈 */
        @media (hover: hover) {
            .btn:hover {
                transform: translateY(-2px);
            }
            
            .btn:active {
                transform: scale(0.95);
            }
        }

        /* 移动设备触觉反馈 */
        @media (hover: none) {
            .btn:active {
                transform: scale(0.95);
            }
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: var(--apple-gray6);
            color: var(--apple-blue);
            border: none;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quantity-btn:hover {
            background: var(--apple-gray5);
            transform: scale(1.05);
        }

        .quantity-btn:active {
            transform: scale(0.95);
        }

        .submit-btn {
            background: var(--apple-green);
            color: white;
            border-radius: 12px;
            padding: 10px 24px;
            font-weight: 500;
            border: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }

        .submit-btn:active {
            transform: scale(0.95);
        }

        .note-input {
            border: 1px solid var(--apple-gray4);
            border-radius: 12px;
            padding: 10px;
            background: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .note-input:focus {
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            outline: none;
        }

        .grid-cols-3-mobile {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        @media (max-width: 768px) {
            .grid-cols-3-mobile {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 0.75rem;
                padding: 0.75rem;
            }
            
            .small-card {
                padding: 1rem;
                min-height: 140px;
            }
            
            .small-card h2 {
                font-size: 1.25rem;
            }
            
            .small-card p {
                font-size: 0.9rem;
                margin-top: 0.5rem;
            }
            .flex-col {
                flex-direction: row !important;
            }
            .product-spec {
                flex-wrap: nowrap;
                display: flex;
                align-items: center;
                width: 100%;
            }
            .spec-group {
                padding: 0.75rem;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .product-spec {
                font-size: 0.95rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 100%;
            }
            .controls-container {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            .controls-row {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                width: 100%;
            }
            .quantity-controls {
                flex: 2;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .unit-input {
                flex: 1;
                min-width: 80px;
                height: 48px;
                font-size: 1.1rem;
                background: white;
                border: 1px solid var(--apple-gray4);
                border-radius: 12px;
                padding: 8px;
                color: var(--apple-dark-gray2);
            }
            .input-number {
                height: 48px;
                font-size: 1.1rem;
                padding: 0 0.5rem;
                min-width: 100px;
                width: 100%;
            }
            .quantity-btn {
                width: 48px;
                height: 48px;
                font-size: 1.5rem;
                padding: 0;
            }
            .product-location {
                font-size: 0.8rem;
                color: #666;
                padding: 0.25rem 0;
            }
            .action-container {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                margin-top: 0.5rem;
                width: 100%;
            }
            .note-input {
                flex: 1;
                height: 36px;
                margin: 0;
            }
            .submit-btn {
                width: auto;
                min-width: 60px;
                height: 36px;
                padding: 0 1rem;
                font-size: 0.9rem;
            }
            .product-code {
                font-size: 0.85rem;
                color: #6b7280;
                margin-bottom: 0.25rem;
            }
        }
        
        .nav-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .small-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 160px;
        }
        
        .small-card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .small-card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            text-align: center;
            color: #1f2937;
        }
        
        .small-card p {
            font-size: 1rem;
            color: #6b7280;
            margin: 0.75rem 0 0 0;
            text-align: center;
        }
        .section-divider {
            border-top: 1px solid #e5e7eb;
            margin: 0.75rem 0;
            padding-top: 0.5rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }
        
        .related-products {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 2rem;
        }
        
        .related-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-group {
            margin-bottom: 1rem;
        }
        
        .card-group-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #4b5563;
            margin: 1rem 0 0.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .bg-stripe-1 {
            background-color: #f3f4f6;
        }
        
        .bg-stripe-2 {
            background-color: #fafbfc;
        }
        
        .bg-stripe-3 {
            background-color: #f0f9ff;
        }
        
        .bg-stripe-4 {
            background-color: #f5f3ff;
        }
        
        .bg-stripe-5 {
            background-color: #fdf2f8;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 1rem;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .fixed-fab {
            display: none;
        }

        .fixed-fab svg {
            width: 24px;
            height: 24px;
        }

        .content-padding {
            padding-top: 1.5rem;
        }

        .quantity-btn {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 8px;
        }

        .quantity-btn:hover {
            background: #e5e7eb;
        }

        .bg-stripe-even {
            background-color: #f3f4f6;
        }

        .bg-stripe-odd {
            background-color: #ffffff;
        }

        .product-name {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .product-spec {
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            padding: 0.25rem 0;
        }
        
        .product-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        
        .product-code {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f9fafb;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .product-location {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 4px;
            display: inline-block;
            margin-left: auto;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .product-location::before {
            content: "📝";
            font-size: 0.7rem;
            opacity: 0;
            margin-right: 4px;
            transition: opacity 0.2s;
        }
        
        .product-location:hover {
            background-color: #dbeafe;
            color: #3b82f6;
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        
        .product-location:hover::before {
            opacity: 1;
        }
        
        .product-location.editing {
            background-color: #dbeafe;
            border: 1px solid var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            color: #1d4ed8;
        }
        
        .product-location.editing::before {
            content: "✏️";
            opacity: 1;
        }
        
        .product-code {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f9fafb;
            border-radius: 4px;
            display: inline-block;
            margin-right: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .spec-group {
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .input-number {
            width: 60px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px;
            height: 40px;
        }

        .quantity-btn {
            font-size: 1.25rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .product-spec {
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            padding: 0.25rem 0;
        }

        .product-location {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 4px;
            display: inline-block;
            margin-left: auto;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .product-location::before {
            content: "📝";
            font-size: 0.7rem;
            opacity: 0;
            margin-right: 4px;
            transition: opacity 0.2s;
        }
        
        .product-location:hover {
            background-color: #dbeafe;
            color: #3b82f6;
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        
        .product-location:hover::before {
            opacity: 1;
        }
        
        .product-location.editing {
            background-color: #dbeafe;
            border: 1px solid var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            color: #1d4ed8;
        }
        
        .product-location.editing::before {
            content: "✏️";
            opacity: 1;
        }
        
        .product-code {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f9fafb;
            border-radius: 4px;
            display: inline-block;
            margin-right: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .nav-container {
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav-main {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .nav-sub {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--apple-blue);
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
        }

        .nav-btn:hover {
            background: var(--apple-gray6);
        }

        .location-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--apple-dark-gray2);
        }

        /* 修改採購按鈕顏色 */
        .submit-btn {
            background-color: var(--apple-blue);  /* 改為藍色 */
            color: white;
            border-radius: 6px;
            padding: 5px 12px;
            font-weight: 500;
            border: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .submit-btn:hover {
            background-color: var(--apple-dark-blue);  /* hover 時變暗藍色 */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);  /* 藍色陰影 */
        }

        #main-sections, #sub-sections, #products-list {
            margin-top: 4rem;
        }

        .product-name-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .quantity-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .quick-nav {
            display: flex;
            gap: 0.5rem;
            padding-right: 1rem;
        }

        .quick-nav-btn {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .quick-nav-btn:hover {
            background: #e5e7eb;
        }

        .section-divider:first-child {
            margin-top: 0;
            border-top: none;
        }

        .note-btn {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .note-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .note-btn.has-note {
            background: #4CAF50;
            border-color: #45a049;
            color: white;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }

        .notification {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            opacity: 0;
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 9999;
            font-size: 1.1rem;
            font-weight: 500;
            backdrop-filter: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification-icon {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
        }

        .notification-icon.loading {
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .notification {
                min-width: auto;
                width: 90%;
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
        
        .submit-btn.with-note {
            background-color: #2196F3;
        }
        
        .submit-btn.with-note:hover {
            background-color: #1976D2;
        }

        .spec-group {
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .input-number {
            width: 60px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px;
            height: 40px;
        }

        /* 加粗 +/- 符號 */
        .quantity-btn {
            font-size: 1.5rem;
            font-weight: 1000;  /* 加粗符號 */
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 8px;
        }

        /* 手機版也要加粗 */
        @media (max-width: 768px) {
            .quantity-btn {
                font-weight: 700;  /* 保持加粗 */
                font-size: 1.75rem;  /* 手機版稍微放大一點 */
            }
        }

        .product-spec {
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            padding: 0.25rem 0;
        }

        .product-location {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 4px;
            display: inline-block;
            margin-left: auto;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .product-location::before {
            content: "📝";
            font-size: 0.7rem;
            opacity: 0;
            margin-right: 4px;
            transition: opacity 0.2s;
        }
        
        .product-location:hover {
            background-color: #dbeafe;
            color: #3b82f6;
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        
        .product-location:hover::before {
            opacity: 1;
        }
        
        .product-location.editing {
            background-color: #dbeafe;
            border: 1px solid var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            color: #1d4ed8;
        }
        
        .product-location.editing::before {
            content: "✏️";
            opacity: 1;
        }
        
        .product-code {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f9fafb;
            border-radius: 4px;
            display: inline-block;
            margin-right: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .note-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .history-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }

        .history-btn:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        .history-btn svg {
            width: 24px;
            height: 24px;
        }

        .history-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--apple-red);
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .history-panel {
            position: fixed;
            bottom: 90px;
            right: 24px;
            width: 320px;
            max-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .history-panel.show {
            display: flex;
        }

        .history-header {
            padding: 16px;
            background: var(--apple-gray6);
            border-bottom: 1px solid var(--apple-gray5);
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--apple-dark-gray2);
        }

        .history-content {
            padding: 16px;
            overflow-y: auto;
            max-height: 320px;
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            font-size: 0.8rem;
            color: var(--apple-gray1);
            margin-bottom: 4px;
        }

        .history-product {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .history-specs {
            color: var(--apple-dark-gray1);
            white-space: pre-line;
            margin-bottom: 4px;
        }

        .history-note {
            color: var(--apple-gray1);
            font-style: italic;
        }

        .clear-history {
            background: none;
            border: none;
            color: var(--apple-red);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .clear-history:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        @media (min-width: 769px) {
            .controls-container {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 1rem;
                width: 100%;
            }
            
            .controls-row {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                width: auto;
            }
            
            .quantity-controls {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                width: auto;
            }
            
            .unit-input {
                width: 100px;
                min-width: 80px;
            }
            
            .input-number {
                width: 80px;
                min-width: 60px;
            }
            
            .product-location {
                margin-left: auto;
            }
        }
        /* 在 nav-main 中的搜尋框樣式 */
#searchInput {
    flex: 1;  /* 讓搜尋框填滿剩餘空間 */
    max-width: 800px;  /* 電腦版最大寬度 */
    min-width: 160px;  /* 最小寬度 */
    padding: 8px 12px;
    border: 1px solid var(--apple-gray4);
    border-radius: 8px;
    background: var(--apple-gray6);
    color: var(--apple-dark-gray2);
    margin-left: auto;  /* 推到右側 */
}

#searchInput:focus {
    background: white;
    border-color: var(--apple-blue);
    outline: none;
}

/* 手機版樣式 */
@media (max-width: 768px) {
    #searchInput {
        max-width: 240px;  /* 手機版最大寬度 */
        font-size: 14px;  /* 手機版字體大小 */
        padding: 6px 10px;  /* 手機版內距 */
    }
    
    .nav-main {
        padding: 0.5rem;  /* 減少導航欄內距 */
    }
}

/* 超小螢幕樣式 */
@media (max-width: 360px) {
    #searchInput {
        max-width: 160px;  /* 超小螢幕最大寬度 */
    }
}

        .input-number.out-of-stock {
            color: #E53E3E;
            font-weight: 500;
            background-color: #FFF5F5;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- 固定頂部 -->
        <div class="fixed-header">
            <div class="container mx-auto">
                <div class="nav-container">
                    <div class="nav-main">
                        <button class="nav-btn" onclick="goBack()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button class="nav-btn" onclick="showMainSections()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            </svg>
                        </button>
                        <div id="header-location" class="location-title">首頁</div>
                        <input type="text" id="searchInput" placeholder="搜尋商品..." oninput="searchProducts(this.value)">
                    </div>
                    <div class="nav-sub" id="quickNavContainer"></div>
                </div>
            </div>
        </div>

        <div class="content-padding">
            <!-- 主區域選擇 -->
            <div id="main-sections" class="mb-8">
                <div class="flex items-center mb-6">
                    <h1 class="text-3xl font-bold">LARK快捷採購</h1>
                    <div id="connection-status" class="status-indicator status-connecting">
                        正在連接數據庫...
                    </div>
                </div>
                <div class="grid-cols-3-mobile" id="mainSectionsGrid">
                </div>
            </div>

            <!-- 子區域選擇 -->
            <div id="sub-sections" class="mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4"><span id="current-section"></span></h2>
                <div class="grid-cols-3-mobile" id="subSectionsGrid">
                </div>
            </div>

            <!-- 商品列表 -->
            <div id="products-list" class="hidden">
                <h2 class="text-2xl font-bold mb-4"><span id="current-location"></span>商品列表</h2>
                <div id="products" class="space-y-4"></div>
            </div>
        </div>

        <!-- 固定採購按鈕 -->
        <button class="fixed-fab" onclick="submitOrder()" title="提交採購清單">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
        </button>

        <!-- 歷史紀錄按鈕 -->
        <button class="history-btn" onclick="toggleHistory()" title="查看採購歷史">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="history-count" id="historyBtnCount">0</span>
        </button>

        <!-- 歷史紀錄面板 -->
        <div class="history-panel" id="historyPanel">
            <div class="history-header">
                <span>採購歷史紀錄 (<span id="historyCount">0</span>)</span>
                <button class="clear-history" onclick="clearHistory()">清除</button>
            </div>
            <div class="history-content" id="historyContent">
            </div>
        </div>
    </div>

    <script>
        let currentSection = '';
        let currentSubSection = '';
        let productsData = [];
        let navigationHistory = [];
        let purchaseHistory = [];
        const HISTORY_EXPIRY = 24 * 60 * 60 * 1000; // 24小時後過期

        // 计算商品数量的全局函数
        function getProductCount(section, sub = null) {
            if (!productsData) return 0;
            
            if (sub) {
                // 计算特定子区域的商品数量
                return productsData.filter(p => {
                    const parts = p.location.split('-');
                    return parts[0] === section && parts[1] === sub;
                }).length;
            } else {
                // 计算整个区域的商品数量（包括所有子区域）
                return productsData.filter(p => 
                    p.location.startsWith(section + '-') || p.location === section
                ).length;
            }
        }

        // 更新連接狀態
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connection-status');
            statusElement.className = 'status-indicator status-' + status;
            statusElement.textContent = message;
        }

        // 從Google Sheets加載數據
        async function loadSheetData() {
            updateConnectionStatus('connecting', '正在連接數據庫...');
            
            const SHEET_ID = '102GIGymYY1WHIIfX2pCk_zUFGwetUIBYObTGM0EvE8c';
            const API_KEY = 'AIzaSyA3h1OJw20eEpPvtAzFM4RH4xOvQyJ7iH4';
            const range = '儲位表!A1:G10000';  // 修改這裡: 指定工作表名稱和範圍
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const rows = data.values;
                if (!rows || rows.length === 0) {
                    throw new Error('No data found.');
                }
                
                // 轉換數據格式並去重
                const uniqueProducts = new Map();
                rows.slice(1).forEach((row, index) => {
                    if (!row[2] || !row[6]) return; // 跳過空行
                    
                    const name = row[2].trim();
                    const spec = (row[3] || '').trim();
                    const location = (row[6] || '').trim();
                    const code = (row[1] || '').trim();  // 添加B欄位
                    
                    const key = `${name}-${spec}`; // 用名稱+規格作為唯一鍵
                    
                    if (!uniqueProducts.has(key) && location) {
                        uniqueProducts.set(key, {
                            id: index.toString(),
                            name: name,
                            spec: spec,
                            code: '',  // 初始值設為空字串
                            cost: row[4] || '',
                            unit: (row[5] || '').trim(),  // F欄位 - 單位
                            location: location,
                            quantity: 0
                        });
                    }
                });

                productsData = Array.from(uniqueProducts.values());
                
                // 獲取所有獨特的區域和子區域
                const sections = new Map();
                productsData.forEach(p => {
                    const location = p.location;
                    if (!location) return;
                    
                    const parts = location.split('-');
                    const mainSection = parts[0];
                    
                    if (!sections.has(mainSection)) {
                        sections.set(mainSection, new Set());
                    }
                    
                    if (parts.length > 1) {
                        sections.get(mainSection).add(parts[1]);
                    }
                });

                // 修改生成主區域HTML的部分
                const mainSectionsHtml = Array.from(sections.keys())
                    .sort()
                    .map(section => {
                        // 計算該區域所有商品的名稱數量（不重複）
                        const allProducts = productsData.filter(p => 
                            p.location === section || p.location.startsWith(section + '-')
                        );
                        const uniqueProductNames = new Set(allProducts.map(p => p.name));
                        const totalProducts = uniqueProductNames.size;
                            
                        return `
                            <div class="small-card" onclick="showSubSections('${section}')">
                                <h2>${section}</h2>
                                <p>${totalProducts} 個商品</p>
                            </div>
                        `;
                    }).join('');
                
                document.getElementById('mainSectionsGrid').innerHTML = mainSectionsHtml;
                window.sectionStructure = sections;
                
                updateConnectionStatus('success', `已連接資料庫`);
                
            } catch (error) {
                console.error('Error loading sheet data:', error);
                updateConnectionStatus('error', '連接失敗: ' + error.message);
            }
        }

        // 導航相關函數
        function goBack() {
            if (navigationHistory.length > 0) {
                const lastState = navigationHistory.pop();
                if (lastState.type === 'main') {
                    showMainSections();
                } else if (lastState.type === 'sub') {
                    showSubSections(lastState.section);
                } else {
                    showProducts(lastState.section, lastState.isDirectSection);
                }
            } else {
                showMainSections();
            }
        }

        function goHome() {
            navigationHistory = [];
            showMainSections();
        }

        function showMainSections() {
            document.getElementById('main-sections').classList.remove('hidden');
            document.getElementById('sub-sections').classList.add('hidden');
            document.getElementById('products-list').classList.add('hidden');
            currentSection = '';
            currentSubSection = '';
            updateHeaderLocation('首頁');
    
        // 清空快捷導航
            const quickNavContainer = document.getElementById('quickNavContainer');
            quickNavContainer.innerHTML = '';
        }

        function showSubSections(section) {
            navigationHistory.push({ type: 'main' });
            currentSection = section;
            updateHeaderLocation(section);
            document.getElementById('current-section').textContent = section;
            
            // 獲取該區域的所有商品
            const directProducts = productsData.filter(p => p.location === section);
            const subSectionProducts = productsData.filter(p => p.location.startsWith(section + '-'));
            
            // 如果只有直接商品，沒有子區域，則直接顯示商品列表
            if (directProducts.length > 0 && subSectionProducts.length === 0) {
                showProducts(section, true);
                return;
            }
            
            // 獲取子區域
            const subSections = new Set(
                subSectionProducts.map(p => p.location.split('-')[1])
            );
            
            let html = '';
            
            // 如果有直接商品，顯示一個特殊的卡片
            if (directProducts.length > 0) {
                const uniqueProductNames = new Set(directProducts.map(p => p.name));
                html += `
                    <div class="small-card" onclick="showProducts('${section}', true)">
                        <h2>主區域</h2>
                        <p>${uniqueProductNames.size} 個商品</p>
                    </div>
                `;
            }
            
            // 顯示子區域（按數字和文字排序）
            html += Array.from(subSections)
                .sort((a, b) => {
                    const aIsNum = /^\d+$/.test(a);
                    const bIsNum = /^\d+$/.test(b);
                    if (aIsNum && bIsNum) return parseInt(a) - parseInt(b);
                    if (aIsNum) return -1;
                    if (bIsNum) return 1;
                    return a.localeCompare(b, 'zh-TW');
                })
                .map(sub => {
                    const subProducts = productsData.filter(p => 
                        p.location === `${section}-${sub}` || 
                        p.location.startsWith(`${section}-${sub}-`)
                    );
                    const uniqueProductNames = new Set(subProducts.map(p => p.name));
                    
                    return `
                        <div class="small-card" onclick="showProducts('${sub}')">
                            <h2>${sub}</h2>
                            <p>${uniqueProductNames.size} 個商品</p>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('subSectionsGrid').innerHTML = html;
            document.getElementById('main-sections').classList.add('hidden');
            document.getElementById('sub-sections').classList.remove('hidden');
            document.getElementById('products-list').classList.add('hidden');
        }

        function showProducts(section, isDirectSection = false) {
            // 儲存當前顯示狀態，用於重新渲染
            window.currentSection = section;
            window.isDirectSection = isDirectSection;
            
            navigationHistory.push({ 
                type: isDirectSection ? 'main' : 'sub', 
                section: currentSection,
                isDirectSection
            });

            const location = isDirectSection ? section : `${currentSection}-${section}`;
            currentSubSection = section;
            updateHeaderLocation(location);
            
            // 获取当前位置的所有商品
            let currentProducts = productsData.filter(p => {
                if (isDirectSection) {
                    // 如果是直接區域，顯示該區域的直接商品
                    return p.location === section;
                } else {
                    // 如果是子區域，顯示該子區域的直接商品和其下級商品
                    const fullLocation = `${currentSection}-${section}`;
                    return p.location === fullLocation || p.location.startsWith(fullLocation + '-');
                }
            });
            
            if (currentProducts.length === 0) {
                document.getElementById('products').innerHTML = '<div class="text-center text-gray-500 mt-4">無商品資料</div>';
                document.getElementById('main-sections').classList.add('hidden');
                document.getElementById('sub-sections').classList.add('hidden');
                document.getElementById('products-list').classList.remove('hidden');
                return;
            }
            
            // 按子區域分組
            const subLocationProducts = new Map();
            currentProducts.forEach(product => {
                const parts = product.location.split('-');
                const currentLevel = isDirectSection ? 1 : 2;
                let subLoc = '主區域';
                
                if (parts.length > currentLevel) {
                    subLoc = parts.slice(currentLevel).join('-');
                }
                
                if (!subLocationProducts.has(subLoc)) {
                    subLocationProducts.set(subLoc, new Map());
                }
                
                const subLocGroup = subLocationProducts.get(subLoc);
                if (!subLocGroup.has(product.name)) {
                    subLocGroup.set(product.name, []);
                }
                subLocGroup.get(product.name).push(product);
            });
            
            // 更新快捷導航
            const quickNavContainer = document.getElementById('quickNavContainer');
            quickNavContainer.innerHTML = '';
            const subLocations = Array.from(subLocationProducts.keys())
                .filter(loc => loc !== '主區域')
                .sort((a, b) => {
                    const aIsNum = /^\d+$/.test(a);
                    const bIsNum = /^\d+$/.test(b);
                    if (aIsNum && bIsNum) return parseInt(a) - parseInt(b);
                    if (aIsNum) return -1;
                    if (bIsNum) return 1;
                    return a.localeCompare(b, 'zh-TW');
                });
            
            if (subLocations.length > 0) {
                const quickNav = document.createElement('div');
                quickNav.className = 'quick-nav';
                
                subLocations.forEach(subLoc => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-nav-btn';
                    btn.textContent = subLoc;
                    btn.onclick = () => {
                        const element = document.getElementById(`section-${subLoc}`);
                        if (element) {
                            const headerOffset = 120;
                            const elementPosition = element.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                            
                            window.scrollTo({
                                top: offsetPosition,
                                behavior: "smooth"
                            });
                        }
                    };
                    quickNav.appendChild(btn);
                });
                
                quickNavContainer.appendChild(quickNav);
            }
            
            // 生成HTML
            let productsHtml = '';
            
            // 先顯示主區域的商品
            if (subLocationProducts.has('主區域')) {
                const mainProducts = subLocationProducts.get('主區域');
                productsHtml += `
                    <div class="section-divider">
                        <div class="section-title">主區域</div>
                        ${Array.from(mainProducts.entries())
                            .sort((a, b) => a[0].localeCompare(b[0], 'zh-TW'))
                            .map(([name, products], index) => 
                                generateProductGroupCard(name, products, index % 2 === 0 ? 'bg-stripe-even' : 'bg-stripe-odd', new Set())
                            ).join('')}
                    </div>
                `;
            }
            
            // 然後顯示子區域的商品（按數字和文字排序）
            subLocations.forEach(subLoc => {
                const subProducts = subLocationProducts.get(subLoc);
                productsHtml += `
                    <div class="section-divider">
                        <div class="section-title" id="section-${subLoc}">${subLoc}</div>
                        ${Array.from(subProducts.entries())
                            .sort((a, b) => a[0].localeCompare(b[0], 'zh-TW'))
                            .map(([name, products], index) => 
                                generateProductGroupCard(name, products, index % 2 === 0 ? 'bg-stripe-even' : 'bg-stripe-odd', new Set())
                            ).join('')}
                    </div>
                `;
            });
            
            document.getElementById('products').innerHTML = productsHtml;
            document.getElementById('main-sections').classList.add('hidden');
            document.getElementById('sub-sections').classList.add('hidden');
            document.getElementById('products-list').classList.remove('hidden');
        }

        // 生成快捷導航按鈕
        function generateQuickNavButtons(location) {
            const parts = location.split('-');
            if (parts.length < 2) return null;

            const prefix = parts.slice(0, 2).join('-');
            const subLocations = productsData
                .filter(p => p.location.startsWith(prefix + '-'))
                .map(p => p.location.split('-')[2])
                .filter((value, index, self) => value && self.indexOf(value) === index)
                .sort((a, b) => parseInt(a) - parseInt(b));

            if (subLocations.length === 0) return null;

            const quickNav = document.createElement('div');
            quickNav.className = 'quick-nav';
            
            subLocations.forEach(subLoc => {
                const btn = document.createElement('button');
                btn.className = 'quick-nav-btn';
                btn.textContent = subLoc;
                btn.onclick = () => scrollToSubLocation(prefix + '-' + subLoc);
                quickNav.appendChild(btn);
            });

            return quickNav;
        }

        // 滾動到指定位置
        function scrollToSubLocation(targetLocation) {
            const sectionTitles = document.querySelectorAll('.section-title');
            let targetElement = null;
            
            for (const title of sectionTitles) {
                if (title.textContent === targetLocation.split('-')[2]) {
                    targetElement = title;
                    break;
                }
            }
            
            if (targetElement) {
                const headerOffset = 100;
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
            }
        }

        // 修改商品組卡片生成函數
        function generateProductGroupCard(productName, products, bgClass = '', shownRelatedProducts = new Set()) {
            // 按規格排序商品
            products.sort((a, b) => a.spec.localeCompare(b.spec, 'zh-TW'));
            
            // 获取当前商品组的位置前缀
            const locationPrefix = products[0].location.split('-').slice(0, 2).join('-');
            
            // 只在商品首次出现在当前位置时显示相关商品
            const shouldShowRelated = !shownRelatedProducts.has(locationPrefix + '-' + productName);
            const currentPageProducts = new Set(products.map(p => p.location));
            const relatedProducts = shouldShowRelated ? productsData.filter(p => 
                p.name === productName && 
                !currentPageProducts.has(p.location)
            ).sort((a, b) => a.spec.localeCompare(b.spec, 'zh-TW')) : [];

            // 判断是否需要折叠（只有当商品有多个规格或有相关商品时才需要）
            const needCollapse = products.length > 1 || relatedProducts.length > 0;
            const productNameId = `${locationPrefix}-${encodeURIComponent(productName)}`;

            return `
                <div class="card ${bgClass}" data-product-id="${productNameId}">
                    <div class="flex justify-between items-center ${needCollapse ? 'cursor-pointer' : ''}" 
                         ${needCollapse ? `onclick="toggleProductSpecs('${productNameId}')"` : ''}>
                        <div>
                            <div class="product-code">${products[0].code || ''}</div>
                            <div class="product-name">${productName}</div>
                        </div>
                        ${needCollapse ? `
                            <div class="text-gray-500">
                                <svg id="arrow-${productNameId}" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        ` : ''}
                    </div>
                    <div id="specs-${productNameId}" class="${needCollapse ? 'hidden' : ''}">
                        ${products.map(product => `
                            <div class="spec-group">
                                <div class="product-spec">${product.spec}</div>
                                <div class="controls-container">
                                    <div class="controls-row">
                                        <div class="quantity-controls">
                                            <button class="quantity-btn" onclick="updateQuantity('${product.id}', -1)">-</button>
                                            <input type="${product.outOfStock ? 'text' : 'number'}" class="input-number" value="${product.outOfStock ? '無庫存' : product.quantity}" 
                                                   onchange="setQuantity('${product.id}', this.value)" min="0"
                                                   ${product.outOfStock ? 'data-out-of-stock="true"' : 'data-out-of-stock="false"'}>
                                            <button class="quantity-btn" onclick="updateQuantity('${product.id}', 1)">+</button>
                                        </div>
                                        <input type="text" class="input-number unit-input" value="" 
                                               onchange="setProductCode('${product.id}', this.value)" 
                                               placeholder="單位">
                                    </div>
                                    <div class="product-info">
                                        ${product.unit ? `<div class="product-code">貨號: ${product.unit}</div>` : ''}
                                        <div class="product-location" onclick="editLocation('${product.name}|${product.spec}', '${product.location}', event)" title="點擊編輯位置">位置: ${product.location}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${shouldShowRelated && relatedProducts.length > 0 ? `
                            <div class="related-products">
                                <div class="related-title">相關商品</div>
                                ${relatedProducts.map(product => `
                                    <div class="spec-group">
                                        <div class="product-spec">${product.spec}</div>
                                        <div class="controls-container">
                                            <div class="controls-row">
                                                <div class="quantity-controls">
                                                    <button class="quantity-btn" onclick="updateQuantity('${product.id}', -1)">-</button>
                                                    <input type="${product.outOfStock ? 'text' : 'number'}" class="input-number" value="${product.outOfStock ? '無庫存' : product.quantity}" 
                                                           onchange="setQuantity('${product.id}', this.value)" min="0"
                                                           ${product.outOfStock ? 'data-out-of-stock="true"' : 'data-out-of-stock="false"'}>
                                                    <button class="quantity-btn" onclick="updateQuantity('${product.id}', 1)">+</button>
                                                </div>
                                                <input type="text" class="input-number unit-input" value="" 
                                                       onchange="setProductCode('${product.id}', this.value)" 
                                                       placeholder="單位">
                                            </div>
                                            <div class="product-info">
                                        ${product.unit ? `<div class="product-code">貨號: ${product.unit}</div>` : ''}
                                        <div class="product-location" onclick="editLocation('${product.name}|${product.spec}', '${product.location}', event)" title="點擊編輯位置">位置: ${product.location}</div>
                                    </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="action-container">
                            <input type="text" class="note-input" placeholder="有備註請輸入" 
                                   onchange="setProductNote('${productNameId}', this.value)">
                            <button class="submit-btn" onclick="submitProductGroup('${productName}')">採購</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 修改切換商品規格顯示的函數
        function toggleProductSpecs(productNameId) {
            const specsDiv = document.getElementById(`specs-${productNameId}`);
            const arrow = document.getElementById(`arrow-${productNameId}`);
            
            if (!specsDiv || !arrow) {
                console.error('找不到對應的元素:', productNameId);
                return;
            }
            
            if (specsDiv.classList.contains('hidden')) {
                specsDiv.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                specsDiv.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // 提交整個商品組
        async function submitProductGroup(productName, withNote = false) {
            // 篩選有數量的商品和標記為無庫存的商品
            const products = productsData.filter(p => 
                p.name === productName && (p.quantity > 0 || p.outOfStock === true)
            );
            
            if (products.length === 0) {
                showNotification('請先選擇採購數量！', 'error');
                return;
            }

            // 找到所有相關的商品卡片（包括主商品和相關商品）
            const allProductCards = document.querySelectorAll(`[data-product-id$="-${encodeURIComponent(productName)}"]`);
            let note = '';

            // 檢查所有卡片中的備註，如果有任何一個有備註就使用它
            allProductCards.forEach(card => {
                const noteInput = card.querySelector('.note-input');
                if (noteInput && noteInput.value.trim()) {
                    note = noteInput.value.trim();
                }
            });

            let specQuantityText = products
                .sort((a, b) => {
                    if (a.spec !== b.spec) {
                        return a.spec.localeCompare(b.spec, 'zh-TW');
                    }
                    return b.quantity - a.quantity;
                })
                .map(product => {
                    let specText = product.spec.trim();
                    let codeText = product.code ? product.code.trim() : '';
                    
                    // 處理無庫存情況
                    if (product.outOfStock === true) {
                        return codeText ? `${specText}*無庫存 ${codeText}` : `${specText}*無庫存`;
                    }
                    
                    if (!specText || specText === '無規格型號' || specText === '(無規格型號)' || /^\s*$/.test(specText)) {
                        return codeText ? `${product.quantity} ${codeText}` : `${product.quantity}`;
                    }
                    
                    if (/^\d+$/.test(specText)) {
                        return codeText ? `${product.quantity} ${codeText}` : `${product.quantity}`;
                    }
                    
                    return codeText ? `${specText}*${product.quantity} ${codeText}` : `${specText}*${product.quantity}`;
                })
                .join('\n');

            try {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWmsOGnwWtjZkk8sxhcIQCeBhyCZdG1ZgUUAMTskquHF9971qTdgM79ODtMUDKFEIZ/exec';
                
                showNotification('正在送出採購單...', 'loading');

                // 創建一個隱藏的 iframe
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                // 創建表單
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hidden_iframe';
                form.style.display = 'none';

                // 添加表單字段
                const addField = (name, value) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = value;
                    form.appendChild(input);
                };

                addField('productName', productName);
                addField('specQuantityText', specQuantityText);
                addField('note', note);

                // 添加表單到文檔並提交
                document.body.appendChild(form);
                form.submit();

                // 清除所有相關商品卡片的數量、單位和備註
                allProductCards.forEach(card => {
                    // 清除數量
                    const quantityInputs = card.querySelectorAll('input[type="number"]');
                    quantityInputs.forEach(input => {
                        input.value = '0';
                        input.dataset.outOfStock = "false";
                    });

                    // 清除單位
                    const unitInputs = card.querySelectorAll('.unit-input');
                    unitInputs.forEach(input => {
                        input.value = '';
                    });

                    // 清除備註
                    const noteInputs = card.querySelectorAll('.note-input');
                    noteInputs.forEach(input => {
                        input.value = '';
                    });
                });

                // 更新數據
                productsData.forEach(product => {
                    if (product.name === productName) {
                        product.quantity = 0;
                        product.outOfStock = false;
                        product.code = '';
                        product.note = '';
                    }
                });

                // 添加歷史紀錄
                addHistoryRecord(productName, specQuantityText, note);

                showNotification('採購單已送出！', 'success');

                // 清理 DOM
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 1000);

            } catch (error) {
                console.error('Error submitting order:', error);
                showNotification('採購單送出失敗，請稍後再試！', 'error');
            }
        }

        // 新增通知函數
        function showNotification(message, type = 'success') {
            // 移除舊的通知
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) {
                oldNotification.remove();
            }

            // 創建新的通知
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            // 根據類型設置樣式
            if (type === 'error') {
                notification.style.backgroundColor = 'rgba(220, 38, 38, 0.95)';
                notification.innerHTML = `<span class="notification-icon">✕</span>${message}`;
            } else if (type === 'loading') {
                notification.style.backgroundColor = 'rgba(59, 130, 246, 0.95)';
                notification.innerHTML = `<span class="notification-icon loading"></span>${message}`;
            } else {
                notification.style.backgroundColor = 'rgba(16, 185, 129, 0.95)';
                notification.innerHTML = `<span class="notification-icon">✓</span>${message}`;
            }

            document.body.appendChild(notification);
            
            // 強制重繪
            notification.offsetHeight;
            
            // 顯示通知
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            // 如果不是 loading 狀態，3秒後自動移除
            if (type !== 'loading') {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 400);
                }, 3000);
            }
        }

        // 新增備註功能
        function addNote(productName) {
            const currentNote = localStorage.getItem(`note-${productName}`) || '';
            const note = prompt('請輸入備註：', currentNote);
            if (note !== null) {
                localStorage.setItem(`note-${productName}`, note);
                // 更新備註按鈕顯示
                const noteBtn = document.querySelector(`button[data-note-btn="${productName}"]`);
                if (noteBtn) {
                    noteBtn.classList.toggle('has-note', note !== '');
                    noteBtn.title = note ? `當前備註: ${note}` : '新增備註';
                }
            }
        }

        // 更新商品數量
        function updateQuantity(productId, delta) {
            const product = productsData.find(p => p.id === productId);
            if (product) {
                const newQuantity = product.quantity + delta;
                
                if (product.quantity === 0 && delta < 0) {
                    // 當數量為0且點擊"-"號時顯示"無庫存"
                    product.outOfStock = true;
                    // 不重新加載頁面，只更新數量顯示
                    const input = document.querySelector(`input[onchange="setQuantity('${productId}', this.value)"]`);
                    if (input) {
                        input.value = "無庫存";
                        input.dataset.outOfStock = "true";
                        input.type = "text"; // 切換為文本輸入
                        input.classList.add("out-of-stock"); // 添加樣式
                    }
                } else {
                    // 其他情況正常處理
                    product.quantity = Math.max(0, newQuantity);
                    product.outOfStock = false;
                    // 不重新加載頁面，只更新數量
                    const input = document.querySelector(`input[onchange="setQuantity('${productId}', this.value)"]`);
                    if (input) {
                        input.value = product.quantity;
                        input.dataset.outOfStock = "false";
                        input.type = "number"; // 確保是數字輸入
                        input.classList.remove("out-of-stock"); // 移除樣式
                    }
                }
            }
        }

        // 設置商品數量
        function setQuantity(productId, value) {
            const product = productsData.find(p => p.id === productId);
            if (product) {
                if (value === "無庫存") {
                    // 如果輸入是"無庫存"
                    product.quantity = 0;
                    product.outOfStock = true;
                    // 更新輸入欄位樣式
                    const input = document.querySelector(`input[onchange="setQuantity('${productId}', this.value)"]`);
                    if (input) {
                        input.type = "text";
                        input.classList.add("out-of-stock");
                    }
                } else {
                    // 如果是數字
                    product.quantity = Math.max(0, parseInt(value) || 0);
                    product.outOfStock = false;
                    // 不重新加載頁面，只更新數量
                    const input = document.querySelector(`input[onchange="setQuantity('${productId}', this.value)"]`);
                    if (input) {
                        input.value = product.quantity;
                        input.dataset.outOfStock = "false";
                        input.type = "number";
                        input.classList.remove("out-of-stock");
                    }
                }
            }
        }

        // 添加 setProductCode 函數
        function setProductCode(productId, value) {
            const product = productsData.find(p => p.id === productId);
            if (product) {
                product.code = value;
            }
        }

        // 搜索商品
        function searchProducts(query) {
            let searchResults = document.getElementById('searchResults');
            const navMain = document.querySelector('.nav-main');
            
            // 如果搜索结果容器不存在，创建一个新的
            if (!searchResults) {
                searchResults = document.createElement('div');
                searchResults.id = 'searchResults';
                searchResults.className = 'search-results hidden';
                navMain.appendChild(searchResults);
            }
            
            // 如果搜索框为空，隐藏结果
            if (!query || !query.trim()) {
                searchResults.classList.add('hidden');
                return;
            }

            const results = productsData.filter(p => 
                p.name.toLowerCase().includes(query.toLowerCase()) ||
                p.spec.toLowerCase().includes(query.toLowerCase())
            );

            if (results.length > 0) {
                const resultsHtml = results.map(product => `
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b" 
                         onclick="navigateToProduct(\`${product.location}\`, \`${product.name.replace(/['"\\]/g, '\\$&')}\`, \`${product.spec.replace(/['"\\]/g, '\\$&')}\`)">
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-600">${product.spec}</div>
                        <div class="text-xs text-gray-500">位置: ${product.location}</div>
                    </div>
                `).join('');
                
                searchResults.innerHTML = resultsHtml;
                searchResults.classList.remove('hidden');
            } else {
                searchResults.innerHTML = '<div class="p-3 text-gray-500">無搜尋結果</div>';
                searchResults.classList.remove('hidden');
            }

            // 点击搜索框外部时隐藏搜索结果
            document.addEventListener('click', function(event) {
                if (!navMain.contains(event.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }

        // 導航到特定商品
        function navigateToProduct(location, productName, productSpec) {
            const parts = location.split('-');
            
            // 重置導航歷史
            navigationHistory = [];
            
            if (parts.length === 1) {
                // 單層位置（如：熱銷區）
                showProducts(parts[0], true);
            } else if (parts.length >= 2) {
                // 兩層或更多層位置（如：B-3 或 A-4-1）
                currentSection = parts[0];
                showProducts(parts[1], false);
            }

            // 等待DOM更新後滾動到商品位置
            setTimeout(() => {
                const productNameId = `${location.split('-').slice(0, 2).join('-')}-${encodeURIComponent(productName)}`;
                const productCard = document.querySelector(`[data-product-id="${productNameId}"]`);
                const specsDiv = document.getElementById(`specs-${productNameId}`);
                const arrow = document.getElementById(`arrow-${productNameId}`);
                
                if (productCard && specsDiv && arrow) {
                    // 展開商品規格
                    specsDiv.classList.remove('hidden');
                    arrow.style.transform = 'rotate(180deg)';
                    
                    // 滾動到商品標題位置
                    const headerOffset = 120; // 考慮頂部導航欄高度
                    const elementPosition = productCard.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                }
            }, 300);
            
            // 清除搜索状态
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.classList.add('hidden');
            }
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
        }

        // 更新頂部標題
        function updateHeaderLocation(text) {
            document.getElementById('header-location').textContent = text;
        }

        // 頁面加載時獲取數據
        loadSheetData();
        
        // 編輯位置功能
        function editLocation(productId, currentLocation, event) {
            event.stopPropagation(); // 防止觸發商品卡片的點擊事件
            
            const newLocation = prompt('請輸入新的位置：', currentLocation);
            if (newLocation && newLocation !== currentLocation) {
                // 立即更新點擊的元素顯示和樣式
                event.target.textContent = `位置: ${newLocation}`;
                event.target.classList.add('editing');
                
                updateLocationInSheet(productId, newLocation, event.target);
            }
        }
        
        // 更新位置到 Google Sheets
        function updateLocationInSheet(productId, newLocation, clickedElement) {
            try {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWmsOGnwWtjZkk8sxhcIQCeBhyCZdG1ZgUUAMTskquHF9971qTdgM79ODtMUDKFEIZ/exec';
                
                showNotification('正在更新位置...', 'loading');

                // 創建一個隱藏的 iframe
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe_location';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                // 創建表單
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hidden_iframe_location';
                form.style.display = 'none';

                // 添加表單字段
                const addField = (name, value) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = value;
                    form.appendChild(input);
                };

                addField('action', 'updateLocation');
                addField('productId', productId);
                addField('newLocation', newLocation);

                // 添加表單到文檔並提交
                document.body.appendChild(form);
                form.submit();

                // 立即更新本地資料並刷新畫面
                const product = productsData.find(p => {
                    const productKey = `${p.name}|${p.spec}`;
                    return productKey === productId;
                });
                
                if (product) {
                    product.location = newLocation;
                }
                
                // 立即更新畫面中的位置顯示 - 重新渲染當前頁面
                if (window.currentSection) {
                    showProducts(window.currentSection, window.isDirectSection);
                }
                
                // 快速回饋給用戶
                setTimeout(() => {
                    showNotification('位置更新成功！', 'success');
                    
                    // 恢復點擊元素的原始樣式
                    if (clickedElement) {
                        clickedElement.style.backgroundColor = '#f3f4f6'; // 恢復原色
                    }
                    
                    // 清理 DOM
                    if (document.body.contains(form)) document.body.removeChild(form);
                    if (document.body.contains(iframe)) document.body.removeChild(iframe);
                }, 600);

            } catch (error) {
                console.error('更新位置錯誤:', error);
                showNotification('更新失敗，請稍後再試', 'error');
            }
        }

        function setProductNote(productNameId, value) {
            const products = productsData.filter(p => {
                const currentProductNameId = `${p.location.split('-').slice(0, 2).join('-')}-${encodeURIComponent(p.name)}`;
                return currentProductNameId === productNameId;
            });
            products.forEach(product => {
                product.note = value;
            });
        }

        // 初始化歷史紀錄
        function initHistory() {
            const savedHistory = localStorage.getItem('purchaseHistory');
            if (savedHistory) {
                const { history, timestamp } = JSON.parse(savedHistory);
                if (Date.now() - timestamp < HISTORY_EXPIRY) {
                    purchaseHistory = history;
                    updateHistoryPanel();
                } else {
                    localStorage.removeItem('purchaseHistory');
                }
            }
        }

        // 切換歷史紀錄面板
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('show');
        }

        // 清除歷史紀錄
        function clearHistory() {
            purchaseHistory = [];
            localStorage.removeItem('purchaseHistory');
            updateHistoryPanel();
        }

        // 更新歷史紀錄面板
        function updateHistoryPanel() {
            const content = document.getElementById('historyContent');
            const countElement = document.getElementById('historyCount');
            const btnCountElement = document.getElementById('historyBtnCount');
            
            countElement.textContent = purchaseHistory.length;
            btnCountElement.textContent = purchaseHistory.length;
            btnCountElement.style.display = purchaseHistory.length > 0 ? 'flex' : 'none';
            
            if (purchaseHistory.length === 0) {
                content.innerHTML = '<div class="history-item">暫無採購紀錄</div>';
                return;
            }

            content.innerHTML = purchaseHistory.map(record => `
                <div class="history-item">
                    <div class="history-time">${record.time}</div>
                    <div class="history-product">${record.productName}</div>
                    <div class="history-specs">${record.specs}</div>
                    ${record.note ? `<div class="history-note">備註: ${record.note}</div>` : ''}
                </div>
            `).join('');
        }

        // 儲存歷史紀錄
        function saveHistory() {
            localStorage.setItem('purchaseHistory', JSON.stringify({
                history: purchaseHistory,
                timestamp: Date.now()
            }));
        }

        // 添加歷史紀錄
        function addHistoryRecord(productName, specs, note) {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            purchaseHistory.unshift({
                time: timeString,
                productName,
                specs,
                note
            });

            // 限制最多保存50筆紀錄
            if (purchaseHistory.length > 50) {
                purchaseHistory.pop();
            }

            saveHistory();
            updateHistoryPanel();
        }

        // 頁面載入時初始化歷史紀錄
        window.addEventListener('load', initHistory);

        // 頁面關閉時清除過期的歷史紀錄
        window.addEventListener('beforeunload', () => {
            const savedHistory = localStorage.getItem('purchaseHistory');
            if (savedHistory) {
                const { timestamp } = JSON.parse(savedHistory);
                if (Date.now() - timestamp >= HISTORY_EXPIRY) {
                    localStorage.removeItem('purchaseHistory');
                }
            }
        });
    </script>
</body>
</html> 