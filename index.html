<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LarkÂø´Êç∑Êé°Ë≥º v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* Apple Á≥ªÁªüÈ¢úËâ≤ */
            --apple-blue: rgb(0, 122, 255);
            --apple-green: rgb(52, 199, 89);
            --apple-indigo: rgb(88, 86, 214);
            --apple-orange: rgb(255, 149, 0);
            --apple-pink: rgb(255, 45, 85);
            --apple-purple: rgb(175, 82, 222);
            --apple-red: rgb(255, 59, 48);
            --apple-teal: rgb(90, 200, 250);
            --apple-yellow: rgb(255, 204, 0);
            --apple-gray1: rgb(142, 142, 147);
            --apple-gray2: rgb(174, 174, 178);
            --apple-gray3: rgb(199, 199, 204);
            --apple-gray4: rgb(209, 209, 214);
            --apple-gray5: rgb(229, 229, 234);
            --apple-gray6: rgb(242, 242, 247);
            
            /* Ê∑±Ëâ≤Ê®°ÂºèÈ¢úËâ≤ */
            --apple-dark-blue: rgb(10, 132, 255);
            --apple-dark-green: rgb(48, 209, 88);
            --apple-dark-indigo: rgb(94, 92, 230);
            --apple-dark-orange: rgb(255, 159, 10);
            --apple-dark-pink: rgb(255, 55, 95);
            --apple-dark-purple: rgb(191, 90, 242);
            --apple-dark-red: rgb(255, 69, 58);
            --apple-dark-teal: rgb(100, 210, 255);
            --apple-dark-yellow: rgb(255, 214, 10);
            --apple-dark-gray1: rgb(142, 142, 147);
            --apple-dark-gray2: rgb(99, 99, 102);
            --apple-dark-gray3: rgb(72, 72, 74);
            --apple-dark-gray4: rgb(58, 58, 60);
            --apple-dark-gray5: rgb(44, 44, 46);
            --apple-dark-gray6: rgb(28, 28, 30);
        }

        /* ÂÖ®Â±ÄÂä®ÁîªËøáÊ∏° */
        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--apple-gray5);
            padding: 20px;
            margin: 12px 0;
            cursor: pointer;
            transform: translateY(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card:active {
            transform: scale(0.98);
        }

        .input-number {
            width: 80px;
            text-align: center;
            border: 1px solid var(--apple-gray4);
            border-radius: 12px;
            padding: 8px;
            font-size: 16px;
            background: white;
            color: var(--apple-dark-gray2);
        }

        .input-number:focus {
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            outline: none;
            background: white;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            background: var(--apple-blue);
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .status-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 14px;
            margin-left: 12px;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            font-weight: 500;
        }

        .status-connecting {
            background: var(--apple-yellow);
            color: #000;
        }

        .status-success {
            background: var(--apple-green);
            color: white;
        }

        .status-error {
            background: var(--apple-red);
            color: white;
        }

        .search-box {
            width: 100%;
            max-width: 500px;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            margin-bottom: 20px;
            background: var(--apple-gray6);
            color: var(--apple-dark-gray2);
        }

        .search-box:focus {
            background: white;
            border: 1px solid var(--apple-gray4);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05),
                        0 4px 16px rgba(0, 0, 0, 0.03);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-container {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 1px 0 var(--apple-gray5);
        }

        .notification {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--apple-dark-gray2);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            z-index: 9999;
            font-size: 1.1rem;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background: var(--apple-green);
        }

        .notification.error {
            background: var(--apple-red);
        }

        .history-panel {
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--apple-gray5);
        }

        /* Âä®ÁîªÂÖ≥ÈîÆÂ∏ß */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Ëß¶ËßâÂèçÈ¶à */
        @media (hover: hover) {
            .btn:hover {
                transform: translateY(-2px);
            }
            
            .btn:active {
                transform: scale(0.95);
            }
        }

        /* ÁßªÂä®ËÆæÂ§áËß¶ËßâÂèçÈ¶à */
        @media (hover: none) {
            .btn:active {
                transform: scale(0.95);
            }
        }

        .quantity-btn {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: var(--apple-gray6);
            color: var(--apple-blue);
            border: none;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quantity-btn:hover {
            background: var(--apple-gray5);
            transform: scale(1.05);
        }

        .quantity-btn:active {
            transform: scale(0.95);
        }

        .submit-btn {
            background: var(--apple-green);
            color: white;
            border-radius: 12px;
            padding: 10px 24px;
            font-weight: 500;
            border: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }

        .submit-btn:active {
            transform: scale(0.95);
        }

        .note-input {
            border: 1px solid var(--apple-gray4);
            border-radius: 12px;
            padding: 10px;
            background: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .note-input:focus {
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            outline: none;
        }

        .grid-cols-3-mobile {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        
        @media (max-width: 768px) {
            .grid-cols-3-mobile {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 0.75rem;
                padding: 0.75rem;
            }
            
            .small-card {
                padding: 1rem;
                min-height: 140px;
            }
            
            .small-card h2 {
                font-size: 1.25rem;
            }
            
            .small-card p {
                font-size: 0.9rem;
                margin-top: 0.5rem;
            }
            .flex-col {
                flex-direction: row !important;
            }
            .product-spec {
                flex-wrap: nowrap;
                display: flex;
                align-items: center;
                width: 100%;
            }
            .spec-group {
                padding: 0.75rem;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .product-spec {
                font-size: 0.95rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 100%;
            }
            .controls-container {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            .controls-row {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                width: 100%;
            }
            .quantity-controls {
                flex: 2;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .unit-input {
                flex: 1;
                min-width: 80px;
                height: 48px;
                font-size: 1.1rem;
                background: white;
                border: 1px solid var(--apple-gray4);
                border-radius: 12px;
                padding: 8px;
                color: var(--apple-dark-gray2);
            }
            .input-number {
                height: 48px;
                font-size: 1.1rem;
                padding: 0 0.5rem;
                min-width: 100px;
                width: 100%;
            }
            .quantity-btn {
                width: 48px;
                height: 48px;
                font-size: 1.5rem;
                padding: 0;
            }
            .product-location {
                font-size: 0.8rem;
                color: #666;
                padding: 0.25rem 0;
            }
            .action-container {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                margin-top: 0.5rem;
                width: 100%;
            }
            .note-input {
                flex: 1;
                height: 36px;
                margin: 0;
            }
            .submit-btn {
                width: auto;
                min-width: 60px;
                height: 36px;
                padding: 0 1rem;
                font-size: 0.9rem;
            }
            .product-code {
                font-size: 0.85rem;
                color: #6b7280;
                margin-bottom: 0.25rem;
            }
        }
        
        .nav-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .small-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 160px;
        }
        
        .small-card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .small-card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            text-align: center;
            color: #1f2937;
        }
        
        .small-card p {
            font-size: 1rem;
            color: #6b7280;
            margin: 0.75rem 0 0 0;
            text-align: center;
        }
        .section-divider {
            border-top: 1px solid #e5e7eb;
            margin: 0.75rem 0;
            padding-top: 0.5rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
        }
        
        .related-products {
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 2rem;
        }
        
        .related-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-group {
            margin-bottom: 1rem;
        }
        
        .card-group-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #4b5563;
            margin: 1rem 0 0.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .bg-stripe-1 {
            background-color: #f3f4f6;
        }
        
        .bg-stripe-2 {
            background-color: #fafbfc;
        }
        
        .bg-stripe-3 {
            background-color: #f0f9ff;
        }
        
        .bg-stripe-4 {
            background-color: #f5f3ff;
        }
        
        .bg-stripe-5 {
            background-color: #fdf2f8;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 1rem;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .fixed-fab {
            display: none;
        }

        .fixed-fab svg {
            width: 24px;
            height: 24px;
        }

        .content-padding {
            padding-top: 1.5rem;
        }

        .quantity-btn {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 8px;
        }

        .quantity-btn:hover {
            background: #e5e7eb;
        }

        .bg-stripe-even {
            background-color: #f3f4f6;
        }

        .bg-stripe-odd {
            background-color: #ffffff;
        }

        .product-name {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .product-spec {
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            padding: 0.25rem 0;
        }
        
        .product-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }
        
        .product-code {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f9fafb;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .product-location {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 4px;
            display: inline-block;
            margin-left: auto;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .product-location::before {
            content: "üìù";
            font-size: 0.7rem;
            opacity: 0;
            margin-right: 4px;
            transition: opacity 0.2s;
        }
        
        .product-location:hover {
            background-color: #dbeafe;
            color: #3b82f6;
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        
        .product-location:hover::before {
            opacity: 1;
        }
        
        .product-location.editing {
            background-color: #dbeafe;
            border: 1px solid var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            color: #1d4ed8;
        }
        
        .product-location.editing::before {
            content: "‚úèÔ∏è";
            opacity: 1;
        }
        
        .product-code {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f9fafb;
            border-radius: 4px;
            display: inline-block;
            margin-right: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .spec-group {
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .input-number {
            width: 60px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px;
            height: 40px;
        }

        .quantity-btn {
            font-size: 1.25rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        .product-spec {
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            padding: 0.25rem 0;
        }

        .product-location {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 4px;
            display: inline-block;
            margin-left: auto;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .product-location::before {
            content: "üìù";
            font-size: 0.7rem;
            opacity: 0;
            margin-right: 4px;
            transition: opacity 0.2s;
        }
        
        .product-location:hover {
            background-color: #dbeafe;
            color: #3b82f6;
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        
        .product-location:hover::before {
            opacity: 1;
        }
        
        .product-location.editing {
            background-color: #dbeafe;
            border: 1px solid var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            color: #1d4ed8;
        }
        
        .product-location.editing::before {
            content: "‚úèÔ∏è";
            opacity: 1;
        }
        
        .product-code {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f9fafb;
            border-radius: 4px;
            display: inline-block;
            margin-right: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .nav-container {
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .nav-main {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }

        .nav-sub {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .nav-btn {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--apple-blue);
        }

        .nav-btn svg {
            width: 24px;
            height: 24px;
        }

        .nav-btn:hover {
            background: var(--apple-gray6);
        }

        .location-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--apple-dark-gray2);
        }

        /* ‰øÆÊîπÊé°Ë≥ºÊåâÈàïÈ°èËâ≤ */
        .submit-btn {
            background-color: var(--apple-blue);  /* ÊîπÁÇ∫ËóçËâ≤ */
            color: white;
            border-radius: 6px;
            padding: 5px 12px;
            font-weight: 500;
            border: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .submit-btn:hover {
            background-color: var(--apple-dark-blue);  /* hover ÊôÇËÆäÊöóËóçËâ≤ */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);  /* ËóçËâ≤Èô∞ÂΩ± */
        }

        #main-sections, #sub-sections, #products-list {
            margin-top: 4rem;
        }

        .product-name-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .quantity-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .quick-nav {
            display: flex;
            gap: 0.5rem;
            padding-right: 1rem;
        }

        .quick-nav-btn {
            background: #f3f4f6;
            color: #374151;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .quick-nav-btn:hover {
            background: #e5e7eb;
        }

        .section-divider:first-child {
            margin-top: 0;
            border-top: none;
        }

        .note-btn {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .note-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        .note-btn.has-note {
            background: #4CAF50;
            border-color: #45a049;
            color: white;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }

        .notification {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            opacity: 0;
            min-width: 280px;
            max-width: 90%;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 9999;
            font-size: 1.1rem;
            font-weight: 500;
            backdrop-filter: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .notification-icon {
            display: inline-block;
            margin-right: 8px;
            font-weight: bold;
        }

        .notification-icon.loading {
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .notification {
                min-width: auto;
                width: 90%;
                padding: 12px 20px;
                font-size: 1rem;
            }
        }
        
        .submit-btn.with-note {
            background-color: #2196F3;
        }
        
        .submit-btn.with-note:hover {
            background-color: #1976D2;
        }

        .spec-group {
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            margin: 0.5rem 0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .input-number {
            width: 60px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px;
            height: 40px;
        }

        /* Âä†Á≤ó +/- Á¨¶Ëôü */
        .quantity-btn {
            font-size: 1.5rem;
            font-weight: 1000;  /* Âä†Á≤óÁ¨¶Ëôü */
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 8px;
        }

        /* ÊâãÊ©üÁâà‰πüË¶ÅÂä†Á≤ó */
        @media (max-width: 768px) {
            .quantity-btn {
                font-weight: 700;  /* ‰øùÊåÅÂä†Á≤ó */
                font-size: 1.75rem;  /* ÊâãÊ©üÁâàÁ®çÂæÆÊîæÂ§ß‰∏ÄÈªû */
            }
        }

        .product-spec {
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            padding: 0.25rem 0;
        }

        .product-location {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f3f4f6;
            border-radius: 4px;
            display: inline-block;
            margin-left: auto;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }
        
        .product-location::before {
            content: "üìù";
            font-size: 0.7rem;
            opacity: 0;
            margin-right: 4px;
            transition: opacity 0.2s;
        }
        
        .product-location:hover {
            background-color: #dbeafe;
            color: #3b82f6;
            border-color: #93c5fd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        
        .product-location:hover::before {
            opacity: 1;
        }
        
        .product-location.editing {
            background-color: #dbeafe;
            border: 1px solid var(--apple-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
            color: #1d4ed8;
        }
        
        .product-location.editing::before {
            content: "‚úèÔ∏è";
            opacity: 1;
        }
        
        .product-code {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            background-color: #f9fafb;
            border-radius: 4px;
            display: inline-block;
            margin-right: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .note-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .history-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }

        .history-btn:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        .history-btn svg {
            width: 24px;
            height: 24px;
        }

        .history-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--apple-red);
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .history-panel {
            position: fixed;
            bottom: 90px;
            right: 24px;
            width: 320px;
            max-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .history-panel.show {
            display: flex;
        }

        .history-header {
            padding: 16px;
            background: var(--apple-gray6);
            border-bottom: 1px solid var(--apple-gray5);
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--apple-dark-gray2);
        }

        .history-content {
            padding: 16px;
            overflow-y: auto;
            max-height: 320px;
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            font-size: 0.8rem;
            color: var(--apple-gray1);
            margin-bottom: 4px;
        }

        .history-product {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .history-specs {
            color: var(--apple-dark-gray1);
            white-space: pre-line;
            margin-bottom: 4px;
        }

        .history-note {
            color: var(--apple-gray1);
            font-style: italic;
        }

        .clear-history {
            background: none;
            border: none;
            color: var(--apple-red);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .clear-history:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        @media (min-width: 769px) {
            .controls-container {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 1rem;
                width: 100%;
            }
            
            .controls-row {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                width: auto;
            }
            
            .quantity-controls {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                width: auto;
            }
            
            .unit-input {
                width: 100px;
                min-width: 80px;
            }
            
            .input-number {
                width: 80px;
                min-width: 60px;
            }
            
            .product-location {
                margin-left: auto;
            }
        }
        /* Âú® nav-main ‰∏≠ÁöÑÊêúÂ∞ãÊ°ÜÊ®£Âºè */
#searchInput {
    flex: 1;  /* ËÆìÊêúÂ∞ãÊ°ÜÂ°´ÊªøÂâ©È§òÁ©∫Èñì */
    max-width: 800px;  /* ÈõªËÖ¶ÁâàÊúÄÂ§ßÂØ¨Â∫¶ */
    min-width: 160px;  /* ÊúÄÂ∞èÂØ¨Â∫¶ */
    padding: 8px 12px;
    border: 1px solid var(--apple-gray4);
    border-radius: 8px;
    background: var(--apple-gray6);
    color: var(--apple-dark-gray2);
    margin-left: auto;  /* Êé®Âà∞Âè≥ÂÅ¥ */
}

#searchInput:focus {
    background: white;
    border-color: var(--apple-blue);
    outline: none;
}

/* ÊâãÊ©üÁâàÊ®£Âºè */
@media (max-width: 768px) {
    #searchInput {
        max-width: 240px;  /* ÊâãÊ©üÁâàÊúÄÂ§ßÂØ¨Â∫¶ */
        font-size: 14px;  /* ÊâãÊ©üÁâàÂ≠óÈ´îÂ§ßÂ∞è */
        padding: 6px 10px;  /* ÊâãÊ©üÁâàÂÖßË∑ù */
    }
    
    .nav-main {
        padding: 0.5rem;  /* Ê∏õÂ∞ëÂ∞éËà™Ê¨ÑÂÖßË∑ù */
    }
}

/* Ë∂ÖÂ∞èËû¢ÂπïÊ®£Âºè */
@media (max-width: 360px) {
    #searchInput {
        max-width: 160px;  /* Ë∂ÖÂ∞èËû¢ÂπïÊúÄÂ§ßÂØ¨Â∫¶ */
    }
}

        .input-number.out-of-stock {
            color: #E53E3E;
            font-weight: 500;
            background-color: #FFF5F5;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Âõ∫ÂÆöÈ†ÇÈÉ® -->
        <div class="fixed-header">
            <div class="container mx-auto">
                <div class="nav-container">
                    <div class="nav-main">
                        <button class="nav-btn" onclick="goBack()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button class="nav-btn" onclick="showMainSections()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            </svg>
                        </button>
                        <div id="header-location" class="location-title">È¶ñÈ†Å</div>
                        <input type="text" id="searchInput" placeholder="ÊêúÂ∞ãÂïÜÂìÅ..." oninput="searchProducts(this.value)">
                    </div>
                    <div class="nav-sub" id="quickNavContainer"></div>
                </div>
            </div>
        </div>

        <div class="content-padding">
            <!-- ‰∏ªÂçÄÂüüÈÅ∏Êìá -->
            <div id="main-sections" class="mb-8">
                <div class="flex items-center mb-6">
                    <h1 class="text-3xl font-bold">LARKÂø´Êç∑Êé°Ë≥º</h1>
                    <div id="connection-status" class="status-indicator status-connecting">
                        Ê≠£Âú®ÈÄ£Êé•Êï∏ÊìöÂ∫´...
                    </div>
                </div>
                <div class="grid-cols-3-mobile" id="mainSectionsGrid">
                </div>
            </div>

            <!-- Â≠êÂçÄÂüüÈÅ∏Êìá -->
            <div id="sub-sections" class="mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4"><span id="current-section"></span></h2>
                <div class="grid-cols-3-mobile" id="subSectionsGrid">
                </div>
            </div>

            <!-- ÂïÜÂìÅÂàóË°® -->
            <div id="products-list" class="hidden">
                <h2 class="text-2xl font-bold mb-4"><span id="current-location"></span>ÂïÜÂìÅÂàóË°®</h2>
                <div id="products" class="space-y-4"></div>
            </div>
        </div>

        <!-- Âõ∫ÂÆöÊé°Ë≥ºÊåâÈàï -->
        <button class="fixed-fab" onclick="submitOrder()" title="Êèê‰∫§Êé°Ë≥ºÊ∏ÖÂñÆ">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
        </button>

        <!-- Ê≠∑Âè≤Á¥ÄÈåÑÊåâÈàï -->
        <button class="history-btn" onclick="toggleHistory()" title="Êü•ÁúãÊé°Ë≥ºÊ≠∑Âè≤">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="history-count" id="historyBtnCount">0</span>
        </button>

        <!-- Ê≠∑Âè≤Á¥ÄÈåÑÈù¢Êùø -->
        <div class="history-panel" id="historyPanel">
            <div class="history-header">
                <span>Êé°Ë≥ºÊ≠∑Âè≤Á¥ÄÈåÑ (<span id="historyCount">0</span>)</span>
                <button class="clear-history" onclick="clearHistory()">Ê∏ÖÈô§</button>
            </div>
            <div class="history-content" id="historyContent">
            </div>
        </div>
    </div>

    <script>
        let currentSection = '';
        let currentSubSection = '';
        let productsData = [];
        let navigationHistory = [];
        let purchaseHistory = [];
        const HISTORY_EXPIRY = 24 * 60 * 60 * 1000; // 24Â∞èÊôÇÂæåÈÅéÊúü

        // ËÆ°ÁÆóÂïÜÂìÅÊï∞ÈáèÁöÑÂÖ®Â±ÄÂáΩÊï∞
        function getProductCount(section, sub = null) {
            if (!productsData) return 0;
            
            if (sub) {
                // ËÆ°ÁÆóÁâπÂÆöÂ≠êÂå∫ÂüüÁöÑÂïÜÂìÅÊï∞Èáè
                return productsData.filter(p => {
                    const parts = p.location.split('-');
                    return parts[0] === section && parts[1] === sub;
                }).length;
            } else {
                // ËÆ°ÁÆóÊï¥‰∏™Âå∫ÂüüÁöÑÂïÜÂìÅÊï∞ÈáèÔºàÂåÖÊã¨ÊâÄÊúâÂ≠êÂå∫ÂüüÔºâ
                return productsData.filter(p => 
                    p.location.startsWith(section + '-') || p.location === section
                ).length;
            }
        }

        // Êõ¥Êñ∞ÈÄ£Êé•ÁãÄÊÖã
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connection-status');
            statusElement.className = 'status-indicator status-' + status;
            statusElement.textContent = message;
        }

        // ÂæûGoogle SheetsÂä†ËºâÊï∏Êìö
        async function loadSheetData() {
            updateConnectionStatus('connecting', 'Ê≠£Âú®ÈÄ£Êé•Êï∏ÊìöÂ∫´...');
            
            const SHEET_ID = '102GIGymYY1WHIIfX2pCk_zUFGwetUIBYObTGM0EvE8c';
            const API_KEY = 'AIzaSyA3h1OJw20eEpPvtAzFM4RH4xOvQyJ7iH4';
            const range = 'ÂÑ≤‰ΩçË°®!A1:G10000';  // ‰øÆÊîπÈÄôË£°: ÊåáÂÆöÂ∑•‰ΩúË°®ÂêçÁ®±ÂíåÁØÑÂúç
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const rows = data.values;
                if (!rows || rows.length === 0) {
                    throw new Error('No data found.');
                }
                
                // ËΩâÊèõÊï∏ÊìöÊ†ºÂºè‰∏¶ÂéªÈáç
                const uniqueProducts = new Map();
                rows.slice(1).forEach((row, index) => {
                    if (!row[2] || !row[6]) return; // Ë∑≥ÈÅéÁ©∫Ë°å
                    
                    const name = row[2].trim();
                    const spec = (row[3] || '').trim();
                    const location = (row[6] || '').trim();
                    const code = (row[1] || '').trim();  // Ê∑ªÂä†BÊ¨Ñ‰Ωç
                    
                    const key = `${name}-${spec}`; // Áî®ÂêçÁ®±+Ë¶èÊ†º‰ΩúÁÇ∫ÂîØ‰∏ÄÈçµ
                    
                    if (!uniqueProducts.has(key) && location) {
                        uniqueProducts.set(key, {
                            id: index.toString(),
                            name: name,
                            spec: spec,
                            code: '',  // ÂàùÂßãÂÄºË®≠ÁÇ∫Á©∫Â≠ó‰∏≤
                            cost: row[4] || '',
                            unit: (row[5] || '').trim(),  // FÊ¨Ñ‰Ωç - ÂñÆ‰Ωç
                            location: location,
                            quantity: 0
                        });
                    }
                });

                productsData = Array.from(uniqueProducts.values());
                
                // Áç≤ÂèñÊâÄÊúâÁç®ÁâπÁöÑÂçÄÂüüÂíåÂ≠êÂçÄÂüü
                const sections = new Map();
                productsData.forEach(p => {
                    const location = p.location;
                    if (!location) return;
                    
                    const parts = location.split('-');
                    const mainSection = parts[0];
                    
                    if (!sections.has(mainSection)) {
                        sections.set(mainSection, new Set());
                    }
                    
                    if (parts.length > 1) {
                        sections.get(mainSection).add(parts[1]);
                    }
                });

                // ‰øÆÊîπÁîüÊàê‰∏ªÂçÄÂüüHTMLÁöÑÈÉ®ÂàÜ
                const mainSectionsHtml = Array.from(sections.keys())
                    .sort()
                    .map(section => {
                        // Ë®àÁÆóË©≤ÂçÄÂüüÊâÄÊúâÂïÜÂìÅÁöÑÂêçÁ®±Êï∏ÈáèÔºà‰∏çÈáçË§áÔºâ
                        const allProducts = productsData.filter(p => 
                            p.location === section || p.location.startsWith(section + '-')
                        );
                        const uniqueProductNames = new Set(allProducts.map(p => p.name));
                        const totalProducts = uniqueProductNames.size;
                            
                        return `
                            <div class="small-card" onclick="showSubSections('${section}')">
                                <h2>${section}</h2>
                                <p>${totalProducts} ÂÄãÂïÜÂìÅ</p>
                            </div>
                        `;
                    }).join('');
                
                document.getElementById('mainSectionsGrid').innerHTML = mainSectionsHtml;
                window.sectionStructure = sections;
                
                updateConnectionStatus('success', `Â∑≤ÈÄ£Êé•Ë≥áÊñôÂ∫´`);
                
            } catch (error) {
                console.error('Error loading sheet data:', error);
                updateConnectionStatus('error', 'ÈÄ£Êé•Â§±Êïó: ' + error.message);
            }
        }

        // Â∞éËà™Áõ∏ÈóúÂáΩÊï∏
        function goBack() {
            if (navigationHistory.length > 0) {
                const lastState = navigationHistory.pop();
                if (lastState.type === 'main') {
                    showMainSections();
                } else if (lastState.type === 'sub') {
                    showSubSections(lastState.section);
                } else {
                    showProducts(lastState.section, lastState.isDirectSection);
                }
            } else {
                showMainSections();
            }
        }

        function goHome() {
            navigationHistory = [];
            showMainSections();
        }

        function showMainSections() {
            document.getElementById('main-sections').classList.remove('hidden');
            document.getElementById('sub-sections').classList.add('hidden');
            document.getElementById('products-list').classList.add('hidden');
            currentSection = '';
            currentSubSection = '';
            updateHeaderLocation('È¶ñÈ†Å');
    
        // Ê∏ÖÁ©∫Âø´Êç∑Â∞éËà™
            const quickNavContainer = document.getElementById('quickNavContainer');
            quickNavContainer.innerHTML = '';
        }

        function showSubSections(section) {
            navigationHistory.push({ type: 'main' });
            currentSection = section;
            updateHeaderLocation(section);
            document.getElementById('current-section').textContent = section;
            
            // Áç≤ÂèñË©≤ÂçÄÂüüÁöÑÊâÄÊúâÂïÜÂìÅ
            const directProducts = productsData.filter(p => p.location === section);
            const subSectionProducts = productsData.filter(p => p.location.startsWith(section + '-'));
            
            // Â¶ÇÊûúÂè™ÊúâÁõ¥Êé•ÂïÜÂìÅÔºåÊ≤íÊúâÂ≠êÂçÄÂüüÔºåÂâáÁõ¥Êé•È°ØÁ§∫ÂïÜÂìÅÂàóË°®
            if (directProducts.length > 0 && subSectionProducts.length === 0) {
                showProducts(section, true);
                return;
            }
            
            // Áç≤ÂèñÂ≠êÂçÄÂüü
            const subSections = new Set(
                subSectionProducts.map(p => p.location.split('-')[1])
            );
            
            let html = '';
            
            // Â¶ÇÊûúÊúâÁõ¥Êé•ÂïÜÂìÅÔºåÈ°ØÁ§∫‰∏ÄÂÄãÁâπÊÆäÁöÑÂç°Áâá
            if (directProducts.length > 0) {
                const uniqueProductNames = new Set(directProducts.map(p => p.name));
                html += `
                    <div class="small-card" onclick="showProducts('${section}', true)">
                        <h2>‰∏ªÂçÄÂüü</h2>
                        <p>${uniqueProductNames.size} ÂÄãÂïÜÂìÅ</p>
                    </div>
                `;
            }
            
            // È°ØÁ§∫Â≠êÂçÄÂüüÔºàÊåâÊï∏Â≠óÂíåÊñáÂ≠óÊéíÂ∫èÔºâ
            html += Array.from(subSections)
                .sort((a, b) => {
                    const aIsNum = /^\d+$/.test(a);
                    const bIsNum = /^\d+$/.test(b);
                    if (aIsNum && bIsNum) return parseInt(a) - parseInt(b);
                    if (aIsNum) return -1;
                    if (bIsNum) return 1;
                    return a.localeCompare(b, 'zh-TW');
                })
                .map(sub => {
                    const subProducts = productsData.filter(p => 
                        p.location === `${section}-${sub}` || 
                        p.location.startsWith(`${section}-${sub}-`)
                    );
                    const uniqueProductNames = new Set(subProducts.map(p => p.name));
                    
                    return `
                        <div class="small-card" onclick="showProducts('${sub}')">
                            <h2>${sub}</h2>
                            <p>${uniqueProductNames.size} ÂÄãÂïÜÂìÅ</p>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('subSectionsGrid').innerHTML = html;
            document.getElementById('main-sections').classList.add('hidden');
            document.getElementById('sub-sections').classList.remove('hidden');
            document.getElementById('products-list').classList.add('hidden');
        }

        function showProducts(section, isDirectSection = false) {
            // ÂÑ≤Â≠òÁï∂ÂâçÈ°ØÁ§∫ÁãÄÊÖãÔºåÁî®ÊñºÈáçÊñ∞Ê∏≤Êüì
            window.currentSection = section;
            window.isDirectSection = isDirectSection;
            
            navigationHistory.push({ 
                type: isDirectSection ? 'main' : 'sub', 
                section: currentSection,
                isDirectSection
            });

            const location = isDirectSection ? section : `${currentSection}-${section}`;
            currentSubSection = section;
            updateHeaderLocation(location);
            
            // Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆÁöÑÊâÄÊúâÂïÜÂìÅ
            let currentProducts = productsData.filter(p => {
                if (isDirectSection) {
                    // Â¶ÇÊûúÊòØÁõ¥Êé•ÂçÄÂüüÔºåÈ°ØÁ§∫Ë©≤ÂçÄÂüüÁöÑÁõ¥Êé•ÂïÜÂìÅ
                    return p.location === section;
                } else {
                    // Â¶ÇÊûúÊòØÂ≠êÂçÄÂüüÔºåÈ°ØÁ§∫Ë©≤Â≠êÂçÄÂüüÁöÑÁõ¥Êé•ÂïÜÂìÅÂíåÂÖ∂‰∏ãÁ¥öÂïÜÂìÅ
                    const fullLocation = `${currentSection}-${section}`;
                    return p.location === fullLocation || p.location.startsWith(fullLocation + '-');
                }
            });
            
            if (currentProducts.length === 0) {
                document.getElementById('products').innerHTML = '<div class="text-center text-gray-500 mt-4">ÁÑ°ÂïÜÂìÅË≥áÊñô</div>';
                document.getElementById('main-sections').classList.add('hidden');
                document.getElementById('sub-sections').classList.add('hidden');
                document.getElementById('products-list').classList.remove('hidden');
                return;
            }
            
            // ÊåâÂ≠êÂçÄÂüüÂàÜÁµÑ
            const subLocationProducts = new Map();
            currentProducts.forEach(product => {
                const parts = product.location.split('-');
                const currentLevel = isDirectSection ? 1 : 2;
                let subLoc = '‰∏ªÂçÄÂüü';
                
                if (parts.length > currentLevel) {
                    subLoc = parts.slice(currentLevel).join('-');
                }
                
                if (!subLocationProducts.has(subLoc)) {
                    subLocationProducts.set(subLoc, new Map());
                }
                
                const subLocGroup = subLocationProducts.get(subLoc);
                if (!subLocGroup.has(product.name)) {
                    subLocGroup.set(product.name, []);
                }
                subLocGroup.get(product.name).push(product);
            });
            
            // Êõ¥Êñ∞Âø´Êç∑Â∞éËà™
            const quickNavContainer = document.getElementById('quickNavContainer');
            quickNavContainer.innerHTML = '';
            const subLocations = Array.from(subLocationProducts.keys())
                .filter(loc => loc !== '‰∏ªÂçÄÂüü')
                .sort((a, b) => {
                    const aIsNum = /^\d+$/.test(a);
                    const bIsNum = /^\d+$/.test(b);
                    if (aIsNum && bIsNum) return parseInt(a) - parseInt(b);
                    if (aIsNum) return -1;
                    if (bIsNum) return 1;
                    return a.localeCompare(b, 'zh-TW');
                });
            
            if (subLocations.length > 0) {
                const quickNav = document.createElement('div');
                quickNav.className = 'quick-nav';
                
                subLocations.forEach(subLoc => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-nav-btn';
                    btn.textContent = subLoc;
                    btn.onclick = () => {
                        const element = document.getElementById(`section-${subLoc}`);
                        if (element) {
                            const headerOffset = 120;
                            const elementPosition = element.getBoundingClientRect().top;
                            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                            
                            window.scrollTo({
                                top: offsetPosition,
                                behavior: "smooth"
                            });
                        }
                    };
                    quickNav.appendChild(btn);
                });
                
                quickNavContainer.appendChild(quickNav);
            }
            
            // ÁîüÊàêHTML
            let productsHtml = '';
            
            // ÂÖàÈ°ØÁ§∫‰∏ªÂçÄÂüüÁöÑÂïÜÂìÅ
            if (subLocationProducts.has('‰∏ªÂçÄÂüü')) {
                const mainProducts = subLocationProducts.get('‰∏ªÂçÄÂüü');
                productsHtml += `
                    <div class="section-divider">
                        <div class="section-title">‰∏ªÂçÄÂüü</div>
                        ${Array.from(mainProducts.entries())
                            .sort((a, b) => a[0].localeCompare(b[0], 'zh-TW'))
                            .map(([name, products], index) => 
                                generateProductGroupCard(name, products, index % 2 === 0 ? 'bg-stripe-even' : 'bg-stripe-odd', new Set())
                            ).join('')}
                    </div>
                `;
            }
            
            // ÁÑ∂ÂæåÈ°ØÁ§∫Â≠êÂçÄÂüüÁöÑÂïÜÂìÅÔºàÊåâÊï∏Â≠óÂíåÊñáÂ≠óÊéíÂ∫èÔºâ
            subLocations.forEach(subLoc => {
                const subProducts = subLocationProducts.get(subLoc);
                productsHtml += `
                    <div class="section-divider">
                        <div class="section-title" id="section-${subLoc}">${subLoc}</div>
                        ${Array.from(subProducts.entries())
                            .sort((a, b) => a[0].localeCompare(b[0], 'zh-TW'))
                            .map(([name, products], index) => 
                                generateProductGroupCard(name, products, index % 2 === 0 ? 'bg-stripe-even' : 'bg-stripe-odd', new Set())
                            ).join('')}
                    </div>
                `;
            });
            
            document.getElementById('products').innerHTML = productsHtml;
            document.getElementById('main-sections').classList.add('hidden');
            document.getElementById('sub-sections').classList.add('hidden');
            document.getElementById('products-list').classList.remove('hidden');
        }

        // ÁîüÊàêÂø´Êç∑Â∞éËà™ÊåâÈàï
        function generateQuickNavButtons(location) {
            const parts = location.split('-');
            if (parts.length < 2) return null;

            const prefix = parts.slice(0, 2).join('-');
            const subLocations = productsData
                .filter(p => p.location.startsWith(prefix + '-'))
                .map(p => p.location.split('-')[2])
                .filter((value, index, self) => value && self.indexOf(value) === index)
                .sort((a, b) => parseInt(a) - parseInt(b));

            if (subLocations.length === 0) return null;

            const quickNav = document.createElement('div');
            quickNav.className = 'quick-nav';
            
            subLocations.forEach(subLoc => {
                const btn = document.createElement('button');
                btn.className = 'quick-nav-btn';
                btn.textContent = subLoc;
                btn.onclick = () => scrollToSubLocation(prefix + '-' + subLoc);
                quickNav.appendChild(btn);
            });

            return quickNav;
        }

        // ÊªæÂãïÂà∞ÊåáÂÆö‰ΩçÁΩÆ
        function scrollToSubLocation(targetLocation) {
            const sectionTitles = document.querySelectorAll('.section-title');
            let targetElement = null;
            
            for (const title of sectionTitles) {
                if (title.textContent === targetLocation.split('-')[2]) {
                    targetElement = title;
                    break;
                }
            }
            
            if (targetElement) {
                const headerOffset = 100;
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                
                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
            }
        }

        // ‰øÆÊîπÂïÜÂìÅÁµÑÂç°ÁâáÁîüÊàêÂáΩÊï∏
        function generateProductGroupCard(productName, products, bgClass = '', shownRelatedProducts = new Set()) {
            // ÊåâË¶èÊ†ºÊéíÂ∫èÂïÜÂìÅ
            products.sort((a, b) => a.spec.localeCompare(b.spec, 'zh-TW'));
            
            // Ëé∑ÂèñÂΩìÂâçÂïÜÂìÅÁªÑÁöÑ‰ΩçÁΩÆÂâçÁºÄ
            const locationPrefix = products[0].location.split('-').slice(0, 2).join('-');
            
            // Âè™Âú®ÂïÜÂìÅÈ¶ñÊ¨°Âá∫Áé∞Âú®ÂΩìÂâç‰ΩçÁΩÆÊó∂ÊòæÁ§∫Áõ∏ÂÖ≥ÂïÜÂìÅ
            const shouldShowRelated = !shownRelatedProducts.has(locationPrefix + '-' + productName);
            const currentPageProducts = new Set(products.map(p => p.location));
            const relatedProducts = shouldShowRelated ? productsData.filter(p => 
                p.name === productName && 
                !currentPageProducts.has(p.location)
            ).sort((a, b) => a.spec.localeCompare(b.spec, 'zh-TW')) : [];

            // Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊäòÂè†ÔºàÂè™ÊúâÂΩìÂïÜÂìÅÊúâÂ§ö‰∏™ËßÑÊ†ºÊàñÊúâÁõ∏ÂÖ≥ÂïÜÂìÅÊó∂ÊâçÈúÄË¶ÅÔºâ
            const needCollapse = products.length > 1 || relatedProducts.length > 0;
            const productNameId = `${locationPrefix}-${encodeURIComponent(productName)}`;

            return `
                <div class="card ${bgClass}" data-product-id="${productNameId}">
                    <div class="flex justify-between items-center ${needCollapse ? 'cursor-pointer' : ''}" 
                         ${needCollapse ? `onclick="toggleProductSpecs('${productNameId}')"` : ''}>
                        <div>
                            <div class="product-code">${products[0].code || ''}</div>
                            <div class="product-name">${productName}</div>
                        </div>
                        ${needCollapse ? `
                            <div class="text-gray-500">
                                <svg id="arrow-${productNameId}" class="w-6 h-6 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        ` : ''}
                    </div>
                    <div id="specs-${productNameId}" class="${needCollapse ? 'hidden' : ''}">
                        ${products.map(product => `
                            <div class="spec-group">
                                <div class="product-spec">${product.spec}</div>
                                <div class="controls-container">
                                    <div class="controls-row">
                                        <div class="quantity-controls">
                                            <button class="quantity-btn" onclick="updateQuantity('${product.id}', -1)">-</button>
                                            <input type="${product.outOfStock ? 'text' : 'number'}" class="input-number" value="${product.outOfStock ? 'ÁÑ°Â∫´Â≠ò' : product.quantity}" 
                                                   onchange="setQuantity('${product.id}', this.value)" min="0"
                                                   ${product.outOfStock ? 'data-out-of-stock="true"' : 'data-out-of-stock="false"'}>
                                            <button class="quantity-btn" onclick="updateQuantity('${product.id}', 1)">+</button>
                                        </div>
                                        <input type="text" class="input-number unit-input" value="" 
                                               onchange="setProductCode('${product.id}', this.value)" 
                                               placeholder="ÂñÆ‰Ωç">
                                    </div>
                                    <div class="product-info">
                                        ${product.unit ? `<div class="product-code">Ë≤®Ëôü: ${product.unit}</div>` : ''}
                                        <div class="product-location" onclick="editLocation('${product.name}|${product.spec}', '${product.location}', event)" title="ÈªûÊìäÁ∑®ËºØ‰ΩçÁΩÆ">‰ΩçÁΩÆ: ${product.location}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${shouldShowRelated && relatedProducts.length > 0 ? `
                            <div class="related-products">
                                <div class="related-title">Áõ∏ÈóúÂïÜÂìÅ</div>
                                ${relatedProducts.map(product => `
                                    <div class="spec-group">
                                        <div class="product-spec">${product.spec}</div>
                                        <div class="controls-container">
                                            <div class="controls-row">
                                                <div class="quantity-controls">
                                                    <button class="quantity-btn" onclick="updateQuantity('${product.id}', -1)">-</button>
                                                    <input type="${product.outOfStock ? 'text' : 'number'}" class="input-number" value="${product.outOfStock ? 'ÁÑ°Â∫´Â≠ò' : product.quantity}" 
                                                           onchange="setQuantity('${product.id}', this.value)" min="0"
                                                           ${product.outOfStock ? 'data-out-of-stock="true"' : 'data-out-of-stock="false"'}>
                                                    <button class="quantity-btn" onclick="updateQuantity('${product.id}', 1)">+</button>
                                                </div>
                                                <input type="text" class="input-number unit-input" value="" 
                                                       onchange="setProductCode('${product.id}', this.value)" 
                                                       placeholder="ÂñÆ‰Ωç">
                                            </div>
                                            <div class="product-info">
                                        ${product.unit ? `<div class="product-code">Ë≤®Ëôü: ${product.unit}</div>` : ''}
                                        <div class="product-location" onclick="editLocation('${product.name}|${product.spec}', '${product.location}', event)" title="ÈªûÊìäÁ∑®ËºØ‰ΩçÁΩÆ">‰ΩçÁΩÆ: ${product.location}</div>
                                    </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="action-container">
                            <input type="text" class="note-input" placeholder="ÊúâÂÇôË®ªË´ãËº∏ÂÖ•" 
                                   onchange="setProductNote('${productNameId}', this.value)">
                            <button class="submit-btn" onclick="submitProductGroup('${productName}')">Êé°Ë≥º</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ‰øÆÊîπÂàáÊèõÂïÜÂìÅË¶èÊ†ºÈ°ØÁ§∫ÁöÑÂáΩÊï∏
        function toggleProductSpecs(productNameId) {
            const specsDiv = document.getElementById(`specs-${productNameId}`);
            const arrow = document.getElementById(`arrow-${productNameId}`);
            
            if (!specsDiv || !arrow) {
                console.error('Êâæ‰∏çÂà∞Â∞çÊáâÁöÑÂÖÉÁ¥†:', productNameId);
                return;
            }
            
            if (specsDiv.classList.contains('hidden')) {
                specsDiv.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                specsDiv.classList.add('hidden');
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Êèê‰∫§Êï¥ÂÄãÂïÜÂìÅÁµÑ
        async function submitProductGroup(productName, withNote = false) {
            // ÁØ©ÈÅ∏ÊúâÊï∏ÈáèÁöÑÂïÜÂìÅÂíåÊ®ôË®òÁÇ∫ÁÑ°Â∫´Â≠òÁöÑÂïÜÂìÅ
            const products = productsData.filter(p => 
                p.name === productName && (p.quantity > 0 || p.outOfStock === true)
            );
            
            if (products.length === 0) {
                showNotification('Ë´ãÂÖàÈÅ∏ÊìáÊé°Ë≥ºÊï∏ÈáèÔºÅ', 'error');
                return;
            }

            // ÊâæÂà∞ÊâÄÊúâÁõ∏ÈóúÁöÑÂïÜÂìÅÂç°ÁâáÔºàÂåÖÊã¨‰∏ªÂïÜÂìÅÂíåÁõ∏ÈóúÂïÜÂìÅÔºâ
            const allProductCards = document.querySelectorAll(`[data-product-id$="-${encodeURIComponent(productName)}"]`);
            let note = '';

            // Ê™¢Êü•ÊâÄÊúâÂç°Áâá‰∏≠ÁöÑÂÇôË®ªÔºåÂ¶ÇÊûúÊúâ‰ªª‰Ωï‰∏ÄÂÄãÊúâÂÇôË®ªÂ∞±‰ΩøÁî®ÂÆÉ
            allProductCards.forEach(card => {
                const noteInput = card.querySelector('.note-input');
                if (noteInput && noteInput.value.trim()) {
                    note = noteInput.value.trim();
                }
            });

            let specQuantityText = products
                .sort((a, b) => {
                    if (a.spec !== b.spec) {
                        return a.spec.localeCompare(b.spec, 'zh-TW');
                    }
                    return b.quantity - a.quantity;
                })
                .map(product => {
                    let specText = product.spec.trim();
                    let codeText = product.code ? product.code.trim() : '';
                    
                    // ËôïÁêÜÁÑ°Â∫´Â≠òÊÉÖÊ≥Å
                    if (product.outOfStock === true) {
                        return codeText ? `${specText}*ÁÑ°Â∫´Â≠ò ${codeText}` : `${specText}*ÁÑ°Â∫´Â≠ò`;
                    }
                    
                    if (!specText || specText === 'ÁÑ°Ë¶èÊ†ºÂûãËôü' || specText === '(ÁÑ°Ë¶èÊ†ºÂûãËôü)' || /^\s*$/.test(specText)) {
                        return codeText ? `${product.quantity} ${codeText}` : `${product.quantity}`;
                    }
                    
                    if (/^\d+$/.test(specText)) {
                        return codeText ? `${product.quantity} ${codeText}` : `${product.quantity}`;
                    }
                    
                    return codeText ? `${specText}*${product.quantity} ${codeText}` : `${specText}*${product.quantity}`;
                })
                .join('\n');

            try {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWmsOGnwWtjZkk8sxhcIQCeBhyCZdG1ZgUUAMTskquHF9971qTdgM79ODtMUDKFEIZ/exec';
                
                showNotification('Ê≠£Âú®ÈÄÅÂá∫Êé°Ë≥ºÂñÆ...', 'loading');

                // ÂâµÂª∫‰∏ÄÂÄãÈö±ËóèÁöÑ iframe
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                // ÂâµÂª∫Ë°®ÂñÆ
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hidden_iframe';
                form.style.display = 'none';

                // Ê∑ªÂä†Ë°®ÂñÆÂ≠óÊÆµ
                const addField = (name, value) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = value;
                    form.appendChild(input);
                };

                addField('productName', productName);
                addField('specQuantityText', specQuantityText);
                addField('note', note);

                // Ê∑ªÂä†Ë°®ÂñÆÂà∞ÊñáÊ™î‰∏¶Êèê‰∫§
                document.body.appendChild(form);
                form.submit();

                // Ê∏ÖÈô§ÊâÄÊúâÁõ∏ÈóúÂïÜÂìÅÂç°ÁâáÁöÑÊï∏Èáè„ÄÅÂñÆ‰ΩçÂíåÂÇôË®ª
                allProductCards.forEach(card => {
                    // Ê∏ÖÈô§Êï∏Èáè
                    const quantityInputs = card.querySelectorAll('input[type="number"]');
                    quantityInputs.forEach(input => {
                        input.value = '0';
                        input.dataset.outOfStock = "false";
                    });

                    // Ê∏ÖÈô§ÂñÆ‰Ωç
                    const unitInputs = card.querySelectorAll('.unit-input');
                    unitInputs.forEach(input => {
                        input.value = '';
                    });

                    // Ê∏ÖÈô§ÂÇôË®ª
                    const noteInputs = card.querySelectorAll('.note-input');
                    noteInputs.forEach(input => {
                        input.value = '';
                    });
                });

                // Êõ¥Êñ∞Êï∏Êìö
                productsData.forEach(product => {
                    if (product.name === productName) {
                        product.quantity = 0;
                        product.outOfStock = false;
                        product.code = '';
                        product.note = '';
                    }
                });

                // Ê∑ªÂä†Ê≠∑Âè≤Á¥ÄÈåÑ
                addHistoryRecord(productName, specQuantityText, note);

                showNotification('Êé°Ë≥ºÂñÆÂ∑≤ÈÄÅÂá∫ÔºÅ', 'success');

                // Ê∏ÖÁêÜ DOM
                setTimeout(() => {
                    document.body.removeChild(form);
                    document.body.removeChild(iframe);
                }, 1000);

            } catch (error) {
                console.error('Error submitting order:', error);
                showNotification('Êé°Ë≥ºÂñÆÈÄÅÂá∫Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶ÔºÅ', 'error');
            }
        }

        // Êñ∞Â¢ûÈÄöÁü•ÂáΩÊï∏
        function showNotification(message, type = 'success') {
            // ÁßªÈô§ËàäÁöÑÈÄöÁü•
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) {
                oldNotification.remove();
            }

            // ÂâµÂª∫Êñ∞ÁöÑÈÄöÁü•
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            // Ê†πÊìöÈ°ûÂûãË®≠ÁΩÆÊ®£Âºè
            if (type === 'error') {
                notification.style.backgroundColor = 'rgba(220, 38, 38, 0.95)';
                notification.innerHTML = `<span class="notification-icon">‚úï</span>${message}`;
            } else if (type === 'loading') {
                notification.style.backgroundColor = 'rgba(59, 130, 246, 0.95)';
                notification.innerHTML = `<span class="notification-icon loading"></span>${message}`;
            } else {
                notification.style.backgroundColor = 'rgba(16, 185, 129, 0.95)';
                notification.innerHTML = `<span class="notification-icon">‚úì</span>${message}`;
            }

            document.body.appendChild(notification);
            
            // Âº∑Âà∂ÈáçÁπ™
            notification.offsetHeight;
            
            // È°ØÁ§∫ÈÄöÁü•
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            // Â¶ÇÊûú‰∏çÊòØ loading ÁãÄÊÖãÔºå3ÁßíÂæåËá™ÂãïÁßªÈô§
            if (type !== 'loading') {
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        notification.remove();
                    }, 400);
                }, 3000);
            }
        }

        // Êñ∞Â¢ûÂÇôË®ªÂäüËÉΩ
        function addNote(productName) {
            const currentNote = localStorage.getItem(`note-${productName}`) || '';
            const note = prompt('Ë´ãËº∏ÂÖ•ÂÇôË®ªÔºö', currentNote);
            if (note !== null) {
                localStorage.setItem(`note-${productName}`, note);
                // Êõ¥Êñ∞ÂÇôË®ªÊåâÈàïÈ°ØÁ§∫
                const noteBtn = document.querySelector(`button[data-note-btn="${productName}"]`);
                if (noteBtn) {
                    noteBtn.classList.toggle('has-note', note !== '');
                    noteBtn.title = note ? `Áï∂ÂâçÂÇôË®ª: ${note}` : 'Êñ∞Â¢ûÂÇôË®ª';
                }
            }
        }

        // Êõ¥Êñ∞ÂïÜÂìÅÊï∏Èáè
        function updateQuantity(productId, delta) {
            const product = productsData.find(p => p.id === productId);
            if (product) {
                const newQuantity = product.quantity + delta;
                
                if (product.quantity === 0 && delta < 0) {
                    // Áï∂Êï∏ÈáèÁÇ∫0‰∏îÈªûÊìä"-"ËôüÊôÇÈ°ØÁ§∫"ÁÑ°Â∫´Â≠ò"
                    product.outOfStock = true;
                    // ‰∏çÈáçÊñ∞Âä†ËºâÈ†ÅÈù¢ÔºåÂè™Êõ¥Êñ∞Êï∏ÈáèÈ°ØÁ§∫
                    const input = document.querySelector(`input[onchange="setQuantity('${productId}', this.value)"]`);
                    if (input) {
                        input.value = "ÁÑ°Â∫´Â≠ò";
                        input.dataset.outOfStock = "true";
                        input.type = "text"; // ÂàáÊèõÁÇ∫ÊñáÊú¨Ëº∏ÂÖ•
                        input.classList.add("out-of-stock"); // Ê∑ªÂä†Ê®£Âºè
                    }
                } else {
                    // ÂÖ∂‰ªñÊÉÖÊ≥ÅÊ≠£Â∏∏ËôïÁêÜ
                    product.quantity = Math.max(0, newQuantity);
                    product.outOfStock = false;
                    // ‰∏çÈáçÊñ∞Âä†ËºâÈ†ÅÈù¢ÔºåÂè™Êõ¥Êñ∞Êï∏Èáè
                    const input = document.querySelector(`input[onchange="setQuantity('${productId}', this.value)"]`);
                    if (input) {
                        input.value = product.quantity;
                        input.dataset.outOfStock = "false";
                        input.type = "number"; // Á¢∫‰øùÊòØÊï∏Â≠óËº∏ÂÖ•
                        input.classList.remove("out-of-stock"); // ÁßªÈô§Ê®£Âºè
                    }
                }
            }
        }

        // Ë®≠ÁΩÆÂïÜÂìÅÊï∏Èáè
        function setQuantity(productId, value) {
            const product = productsData.find(p => p.id === productId);
            if (product) {
                if (value === "ÁÑ°Â∫´Â≠ò") {
                    // Â¶ÇÊûúËº∏ÂÖ•ÊòØ"ÁÑ°Â∫´Â≠ò"
                    product.quantity = 0;
                    product.outOfStock = true;
                    // Êõ¥Êñ∞Ëº∏ÂÖ•Ê¨Ñ‰ΩçÊ®£Âºè
                    const input = document.querySelector(`input[onchange="setQuantity('${productId}', this.value)"]`);
                    if (input) {
                        input.type = "text";
                        input.classList.add("out-of-stock");
                    }
                } else {
                    // Â¶ÇÊûúÊòØÊï∏Â≠ó
                    product.quantity = Math.max(0, parseInt(value) || 0);
                    product.outOfStock = false;
                    // ‰∏çÈáçÊñ∞Âä†ËºâÈ†ÅÈù¢ÔºåÂè™Êõ¥Êñ∞Êï∏Èáè
                    const input = document.querySelector(`input[onchange="setQuantity('${productId}', this.value)"]`);
                    if (input) {
                        input.value = product.quantity;
                        input.dataset.outOfStock = "false";
                        input.type = "number";
                        input.classList.remove("out-of-stock");
                    }
                }
            }
        }

        // Ê∑ªÂä† setProductCode ÂáΩÊï∏
        function setProductCode(productId, value) {
            const product = productsData.find(p => p.id === productId);
            if (product) {
                product.code = value;
            }
        }

        // ÊêúÁ¥¢ÂïÜÂìÅ
        function searchProducts(query) {
            let searchResults = document.getElementById('searchResults');
            const navMain = document.querySelector('.nav-main');
            
            // Â¶ÇÊûúÊêúÁ¥¢ÁªìÊûúÂÆπÂô®‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ
            if (!searchResults) {
                searchResults = document.createElement('div');
                searchResults.id = 'searchResults';
                searchResults.className = 'search-results hidden';
                navMain.appendChild(searchResults);
            }
            
            // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫ÔºåÈöêËóèÁªìÊûú
            if (!query || !query.trim()) {
                searchResults.classList.add('hidden');
                return;
            }

            const results = productsData.filter(p => 
                p.name.toLowerCase().includes(query.toLowerCase()) ||
                p.spec.toLowerCase().includes(query.toLowerCase())
            );

            if (results.length > 0) {
                const resultsHtml = results.map(product => `
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b" 
                         onclick="navigateToProduct(\`${product.location}\`, \`${product.name.replace(/['"\\]/g, '\\$&')}\`, \`${product.spec.replace(/['"\\]/g, '\\$&')}\`)">
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-600">${product.spec}</div>
                        <div class="text-xs text-gray-500">‰ΩçÁΩÆ: ${product.location}</div>
                    </div>
                `).join('');
                
                searchResults.innerHTML = resultsHtml;
                searchResults.classList.remove('hidden');
            } else {
                searchResults.innerHTML = '<div class="p-3 text-gray-500">ÁÑ°ÊêúÂ∞ãÁµêÊûú</div>';
                searchResults.classList.remove('hidden');
            }

            // ÁÇπÂáªÊêúÁ¥¢Ê°ÜÂ§ñÈÉ®Êó∂ÈöêËóèÊêúÁ¥¢ÁªìÊûú
            document.addEventListener('click', function(event) {
                if (!navMain.contains(event.target)) {
                    searchResults.classList.add('hidden');
                }
            });
        }

        // Â∞éËà™Âà∞ÁâπÂÆöÂïÜÂìÅ
        function navigateToProduct(location, productName, productSpec) {
            const parts = location.split('-');
            
            // ÈáçÁΩÆÂ∞éËà™Ê≠∑Âè≤
            navigationHistory = [];
            
            if (parts.length === 1) {
                // ÂñÆÂ±§‰ΩçÁΩÆÔºàÂ¶ÇÔºöÁÜ±Èä∑ÂçÄÔºâ
                showProducts(parts[0], true);
            } else if (parts.length >= 2) {
                // ÂÖ©Â±§ÊàñÊõ¥Â§öÂ±§‰ΩçÁΩÆÔºàÂ¶ÇÔºöB-3 Êàñ A-4-1Ôºâ
                currentSection = parts[0];
                showProducts(parts[1], false);
            }

            // Á≠âÂæÖDOMÊõ¥Êñ∞ÂæåÊªæÂãïÂà∞ÂïÜÂìÅ‰ΩçÁΩÆ
            setTimeout(() => {
                const productNameId = `${location.split('-').slice(0, 2).join('-')}-${encodeURIComponent(productName)}`;
                const productCard = document.querySelector(`[data-product-id="${productNameId}"]`);
                const specsDiv = document.getElementById(`specs-${productNameId}`);
                const arrow = document.getElementById(`arrow-${productNameId}`);
                
                if (productCard && specsDiv && arrow) {
                    // Â±ïÈñãÂïÜÂìÅË¶èÊ†º
                    specsDiv.classList.remove('hidden');
                    arrow.style.transform = 'rotate(180deg)';
                    
                    // ÊªæÂãïÂà∞ÂïÜÂìÅÊ®ôÈ°å‰ΩçÁΩÆ
                    const headerOffset = 120; // ËÄÉÊÖÆÈ†ÇÈÉ®Â∞éËà™Ê¨ÑÈ´òÂ∫¶
                    const elementPosition = productCard.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: "smooth"
                    });
                }
            }, 300);
            
            // Ê∏ÖÈô§ÊêúÁ¥¢Áä∂ÊÄÅ
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.classList.add('hidden');
            }
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
        }

        // Êõ¥Êñ∞È†ÇÈÉ®Ê®ôÈ°å
        function updateHeaderLocation(text) {
            document.getElementById('header-location').textContent = text;
        }

        // È†ÅÈù¢Âä†ËºâÊôÇÁç≤ÂèñÊï∏Êìö
        loadSheetData();
        
        // Á∑®ËºØ‰ΩçÁΩÆÂäüËÉΩ
        function editLocation(productId, currentLocation, event) {
            event.stopPropagation(); // Èò≤Ê≠¢Ëß∏ÁôºÂïÜÂìÅÂç°ÁâáÁöÑÈªûÊìä‰∫ã‰ª∂
            
            const newLocation = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÁöÑ‰ΩçÁΩÆÔºö', currentLocation);
            if (newLocation && newLocation !== currentLocation) {
                // Á´ãÂç≥Êõ¥Êñ∞ÈªûÊìäÁöÑÂÖÉÁ¥†È°ØÁ§∫ÂíåÊ®£Âºè
                event.target.textContent = `‰ΩçÁΩÆ: ${newLocation}`;
                event.target.classList.add('editing');
                
                updateLocationInSheet(productId, newLocation, event.target);
            }
        }
        
        // Êõ¥Êñ∞‰ΩçÁΩÆÂà∞ Google Sheets
        function updateLocationInSheet(productId, newLocation, clickedElement) {
            try {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWmsOGnwWtjZkk8sxhcIQCeBhyCZdG1ZgUUAMTskquHF9971qTdgM79ODtMUDKFEIZ/exec';
                
                showNotification('Ê≠£Âú®Êõ¥Êñ∞‰ΩçÁΩÆ...', 'loading');

                // ÂâµÂª∫‰∏ÄÂÄãÈö±ËóèÁöÑ iframe
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden_iframe_location';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);

                // ÂâµÂª∫Ë°®ÂñÆ
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = APPS_SCRIPT_URL;
                form.target = 'hidden_iframe_location';
                form.style.display = 'none';

                // Ê∑ªÂä†Ë°®ÂñÆÂ≠óÊÆµ
                const addField = (name, value) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = name;
                    input.value = value;
                    form.appendChild(input);
                };

                addField('action', 'updateLocation');
                addField('productId', productId);
                addField('newLocation', newLocation);

                // Ê∑ªÂä†Ë°®ÂñÆÂà∞ÊñáÊ™î‰∏¶Êèê‰∫§
                document.body.appendChild(form);
                form.submit();

                // Á´ãÂç≥Êõ¥Êñ∞Êú¨Âú∞Ë≥áÊñô‰∏¶Âà∑Êñ∞Áï´Èù¢
                const product = productsData.find(p => {
                    const productKey = `${p.name}|${p.spec}`;
                    return productKey === productId;
                });
                
                if (product) {
                    product.location = newLocation;
                }
                
                // Á´ãÂç≥Êõ¥Êñ∞Áï´Èù¢‰∏≠ÁöÑ‰ΩçÁΩÆÈ°ØÁ§∫ - ÈáçÊñ∞Ê∏≤ÊüìÁï∂ÂâçÈ†ÅÈù¢
                if (window.currentSection) {
                    showProducts(window.currentSection, window.isDirectSection);
                }
                
                // Âø´ÈÄüÂõûÈ•ãÁµ¶Áî®Êà∂
                setTimeout(() => {
                    showNotification('‰ΩçÁΩÆÊõ¥Êñ∞ÊàêÂäüÔºÅ', 'success');
                    
                    // ÊÅ¢Âæ©ÈªûÊìäÂÖÉÁ¥†ÁöÑÂéüÂßãÊ®£Âºè
                    if (clickedElement) {
                        clickedElement.style.backgroundColor = '#f3f4f6'; // ÊÅ¢Âæ©ÂéüËâ≤
                    }
                    
                    // Ê∏ÖÁêÜ DOM
                    if (document.body.contains(form)) document.body.removeChild(form);
                    if (document.body.contains(iframe)) document.body.removeChild(iframe);
                }, 600);

            } catch (error) {
                console.error('Êõ¥Êñ∞‰ΩçÁΩÆÈåØË™§:', error);
                showNotification('Êõ¥Êñ∞Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
            }
        }

        function setProductNote(productNameId, value) {
            const products = productsData.filter(p => {
                const currentProductNameId = `${p.location.split('-').slice(0, 2).join('-')}-${encodeURIComponent(p.name)}`;
                return currentProductNameId === productNameId;
            });
            products.forEach(product => {
                product.note = value;
            });
        }

        // ÂàùÂßãÂåñÊ≠∑Âè≤Á¥ÄÈåÑ
        function initHistory() {
            const savedHistory = localStorage.getItem('purchaseHistory');
            if (savedHistory) {
                const { history, timestamp } = JSON.parse(savedHistory);
                if (Date.now() - timestamp < HISTORY_EXPIRY) {
                    purchaseHistory = history;
                    updateHistoryPanel();
                } else {
                    localStorage.removeItem('purchaseHistory');
                }
            }
        }

        // ÂàáÊèõÊ≠∑Âè≤Á¥ÄÈåÑÈù¢Êùø
        function toggleHistory() {
            const panel = document.getElementById('historyPanel');
            panel.classList.toggle('show');
        }

        // Ê∏ÖÈô§Ê≠∑Âè≤Á¥ÄÈåÑ
        function clearHistory() {
            purchaseHistory = [];
            localStorage.removeItem('purchaseHistory');
            updateHistoryPanel();
        }

        // Êõ¥Êñ∞Ê≠∑Âè≤Á¥ÄÈåÑÈù¢Êùø
        function updateHistoryPanel() {
            const content = document.getElementById('historyContent');
            const countElement = document.getElementById('historyCount');
            const btnCountElement = document.getElementById('historyBtnCount');
            
            countElement.textContent = purchaseHistory.length;
            btnCountElement.textContent = purchaseHistory.length;
            btnCountElement.style.display = purchaseHistory.length > 0 ? 'flex' : 'none';
            
            if (purchaseHistory.length === 0) {
                content.innerHTML = '<div class="history-item">Êö´ÁÑ°Êé°Ë≥ºÁ¥ÄÈåÑ</div>';
                return;
            }

            content.innerHTML = purchaseHistory.map(record => `
                <div class="history-item">
                    <div class="history-time">${record.time}</div>
                    <div class="history-product">${record.productName}</div>
                    <div class="history-specs">${record.specs}</div>
                    ${record.note ? `<div class="history-note">ÂÇôË®ª: ${record.note}</div>` : ''}
                </div>
            `).join('');
        }

        // ÂÑ≤Â≠òÊ≠∑Âè≤Á¥ÄÈåÑ
        function saveHistory() {
            localStorage.setItem('purchaseHistory', JSON.stringify({
                history: purchaseHistory,
                timestamp: Date.now()
            }));
        }

        // Ê∑ªÂä†Ê≠∑Âè≤Á¥ÄÈåÑ
        function addHistoryRecord(productName, specs, note) {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            purchaseHistory.unshift({
                time: timeString,
                productName,
                specs,
                note
            });

            // ÈôêÂà∂ÊúÄÂ§ö‰øùÂ≠ò50Á≠ÜÁ¥ÄÈåÑ
            if (purchaseHistory.length > 50) {
                purchaseHistory.pop();
            }

            saveHistory();
            updateHistoryPanel();
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñÊ≠∑Âè≤Á¥ÄÈåÑ
        window.addEventListener('load', initHistory);

        // È†ÅÈù¢ÈóúÈñâÊôÇÊ∏ÖÈô§ÈÅéÊúüÁöÑÊ≠∑Âè≤Á¥ÄÈåÑ
        window.addEventListener('beforeunload', () => {
            const savedHistory = localStorage.getItem('purchaseHistory');
            if (savedHistory) {
                const { timestamp } = JSON.parse(savedHistory);
                if (Date.now() - timestamp >= HISTORY_EXPIRY) {
                    localStorage.removeItem('purchaseHistory');
                }
            }
        });
    </script>
</body>
</html> 